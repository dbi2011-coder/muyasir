// ============================================
// ğŸ“ Ø§Ù„Ù…Ù„Ù: student-profile.js (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
// ============================================

// Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø®Ø·Ø© Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ

document.addEventListener('DOMContentLoaded', function() {
    initializeStudentProfile();
});

function initializeStudentProfile() {
    const currentUser = getCurrentUser();
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = parseInt(urlParams.get('id'));
    
    if (!studentId) {
        showAuthNotification('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø·Ø§Ù„Ø¨', 'error');
        setTimeout(() => window.history.back(), 2000);
        return;
    }
    
    loadStudentProfile(studentId);
    setupIEPAutoGeneration(studentId);
}

function setupIEPAutoGeneration(studentId) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø®ØªØ¨Ø§Ø± ØªØ´Ø®ÙŠØµÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨
    checkAndGenerateIEP(studentId);
}

// ============================================
// Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø®Ø·Ø© Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ©
// ============================================

function checkAndGenerateIEP(studentId) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø®ØªØ¨Ø§Ø± ØªØ´Ø®ÙŠØµÙŠ Ù…ÙƒØªÙ…Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨
    const diagnosticTest = getStudentDiagnosticTest(studentId);
    
    if (diagnosticTest && diagnosticTest.status === 'completed' && !diagnosticTest.iepGenerated) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙƒØªÙ…Ù„ ÙˆÙ„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø¨Ø¹Ø¯
        autoGenerateIEPFromDiagnostic(studentId, diagnosticTest);
    }
}

function getStudentDiagnosticTest(studentId) {
    const tests = JSON.parse(localStorage.getItem('tests') || '[]');
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨
    return tests.find(test => 
        test.studentId === studentId && 
        test.type === 'diagnostic' &&
        test.status === 'completed'
    );
}

async function autoGenerateIEPFromDiagnostic(studentId, diagnosticTest) {
    try {
        showAuthNotification('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...', 'info');
        
        // ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const analysis = await analyzeDiagnosticResults(diagnosticTest);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ©
        const iepData = await generateIEPData(studentId, analysis);
        
        // Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø©
        await saveAutoGeneratedIEP(studentId, iepData);
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        markIEPAsGenerated(diagnosticTest.id);
        
        showAuthNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹', 'success');
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…ÙØªÙˆØ­Ø§Ù‹ØŒ ØªØ­Ø¯ÙŠØ«Ù‡
        if (document.getElementById('iepSection')) {
            setTimeout(() => {
                populateIEPForm(iepData);
            }, 1000);
        }
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:', error);
        showAuthNotification('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©', 'error');
    }
}

async function analyzeDiagnosticResults(diagnosticTest) {
    // ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    const questions = diagnosticTest.questions || [];
    const studentAnswers = diagnosticTest.studentAnswers || {};
    
    const analysis = {
        strengths: [],      // Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© (Ø£Ø³Ø¦Ù„Ø© ØµØ­ÙŠØ­Ø©)
        weaknesses: [],     // Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ (Ø£Ø³Ø¦Ù„Ø© Ø®Ø§Ø·Ø¦Ø©)
        totalQuestions: questions.length,
        correctCount: 0,
        incorrectCount: 0
    };
    
    // ØªØ­Ù„ÙŠÙ„ ÙƒÙ„ Ø³Ø¤Ø§Ù„
    questions.forEach((question, index) => {
        const studentAnswer = studentAnswers[question.id];
        const isCorrect = studentAnswer && studentAnswer.isCorrect;
        
        if (isCorrect) {
            analysis.correctCount++;
            analysis.strengths.push({
                questionId: question.id,
                questionText: question.text,
                shortTermGoal: question.shortTermGoal,
                instructionalGoals: question.instructionalGoals || []
            });
        } else {
            analysis.incorrectCount++;
            analysis.weaknesses.push({
                questionId: question.id,
                questionText: question.text,
                shortTermGoal: question.shortTermGoal,
                instructionalGoals: question.instructionalGoals || []
            });
        }
    });
    
    return analysis;
}

async function generateIEPData(studentId, analysis) {
    const student = getStudentById(studentId);
    const teacher = getCurrentUser();
    const schedule = getTeacherSchedule(teacher.id);
    
    // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù‚Ù‚ (Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…Ù† Ø§Ù„Ø¢Ù†)
    const verificationDate = new Date();
    verificationDate.setDate(verificationDate.getDate() + 14);
    
    // ØªÙˆÙ„ÙŠØ¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© (Ø£Ù‡Ø¯Ø§Ù Ù‚ØµÙŠØ±Ø© ÙÙ‚Ø·)
    const strengths = analysis.strengths.map(item => ({
        type: 'strength',
        shortTermGoal: item.shortTermGoal,
        sourceQuestion: item.questionText
    }));
    
    // ØªÙˆÙ„ÙŠØ¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ (Ø£Ù‡Ø¯Ø§Ù Ù‚ØµÙŠØ±Ø© Ù…Ø¹ ØªØ¯Ø±ÙŠØ³ÙŠØ©)
    const weaknesses = analysis.weaknesses.map(item => ({
        type: 'weakness',
        shortTermGoal: item.shortTermGoal,
        instructionalGoals: item.instructionalGoals,
        sourceQuestion: item.questionText,
        verificationDate: verificationDate.toISOString().split('T')[0],
        scheduleSlots: getAvailableScheduleSlots(schedule)
    }));
    
    return {
        studentId: studentId,
        studentName: student.name,
        studentGrade: student.grade,
        teacherId: teacher.id,
        teacherName: teacher.name,
        generatedDate: new Date().toISOString(),
        diagnosticTestId: analysis.diagnosticTestId,
        strengths: strengths,
        weaknesses: weaknesses,
        schedule: schedule,
        status: 'auto-generated'
    };
}

async function saveAutoGeneratedIEP(studentId, iepData) {
    const ieps = JSON.parse(localStorage.getItem('studentIEPs') || '[]');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø© Ø³Ø§Ø¨Ù‚Ø©
    const existingIEPIndex = ieps.findIndex(iep => iep.studentId === studentId);
    
    const newIEP = {
        id: generateId(),
        ...iepData,
        lastUpdated: new Date().toISOString(),
        version: '1.0'
    };
    
    if (existingIEPIndex !== -1) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        ieps[existingIEPIndex] = newIEP;
    } else {
        // Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©
        ieps.push(newIEP);
    }
    
    localStorage.setItem('studentIEPs', JSON.stringify(ieps));
    
    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·
    addStudentActivity(studentId, {
        type: 'iep_generated',
        title: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹',
        description: `Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ (${iepData.correctCount} ØµØ­ÙŠØ­Ø©ØŒ ${iepData.incorrectCount} Ø®Ø§Ø·Ø¦Ø©)`,
        timestamp: new Date().toISOString()
    });
}

function markIEPAsGenerated(testId) {
    const tests = JSON.parse(localStorage.getItem('tests') || '[]');
    const testIndex = tests.findIndex(t => t.id === testId);
    
    if (testIndex !== -1) {
        tests[testIndex].iepGenerated = true;
        tests[testIndex].iepGeneratedAt = new Date().toISOString();
        localStorage.setItem('tests', JSON.stringify(tests));
    }
}

// ============================================
// Ø¯Ø§Ù„Ø© ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
// ============================================

function populateIEPForm(iepData) {
    if (!iepData) {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = parseInt(urlParams.get('id'));
        iepData = getStudentIEP(studentId);
        
        if (!iepData) return;
    }
    
    // ØªØ¹Ø¨Ø¦Ø© Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©
    populateStrengthsSection(iepData.strengths);
    
    // ØªØ¹Ø¨Ø¦Ø© Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬
    populateWeaknessesSection(iepData.weaknesses);
    
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
    populateIEPTable(iepData.weaknesses, iepData.schedule);
    
    // ØªØ¹Ø¨Ø¦Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
    populateStudentInfo(iepData);
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø£Ù† Ø§Ù„Ø®Ø·Ø© Ù…Ø¹Ø¨Ø£Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    showAutoGeneratedMessage(iepData);
}

function populateStrengthsSection(strengths) {
    const strengthsContainer = document.getElementById('strengthsList');
    if (!strengthsContainer) return;
    
    strengthsContainer.innerHTML = strengths.map((strength, index) => `
        <div class="strength-item" data-index="${index}">
            <input type="text" 
                   class="form-control strength-goal" 
                   value="${escapeHtml(strength.shortTermGoal)}"
                   placeholder="Ù‡Ø¯Ù Ù‚ØµÙŠØ± Ø§Ù„Ù…Ø¯Ù‰">
            <button type="button" class="btn btn-sm btn-danger remove-strength" onclick="removeStrength(${index})">
                Ø­Ø°Ù
            </button>
        </div>
    `).join('');
}

function populateWeaknessesSection(weaknesses) {
    const weaknessesContainer = document.getElementById('weaknessesList');
    if (!weaknessesContainer) return;
    
    weaknessesContainer.innerHTML = weaknesses.map((weakness, index) => `
        <div class="weakness-item" data-index="${index}">
            <input type="text" 
                   class="form-control weakness-goal" 
                   value="${escapeHtml(weakness.shortTermGoal)}"
                   placeholder="Ù‡Ø¯Ù Ù‚ØµÙŠØ± Ø§Ù„Ù…Ø¯Ù‰">
            <button type="button" class="btn btn-sm btn-danger remove-weakness" onclick="removeWeakness(${index})">
                Ø­Ø°Ù
            </button>
        </div>
    `).join('');
}

function populateIEPTable(weaknesses, schedule) {
    const iepTableBody = document.getElementById('iepTableBody');
    if (!iepTableBody) return;
    
    iepTableBody.innerHTML = weaknesses.map((weakness, index) => {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const scheduleSlot = weakness.scheduleSlots && weakness.scheduleSlots.length > 0 
            ? weakness.scheduleSlots[0] 
            : { day: 'Ø§Ù„Ø£Ø­Ø¯', time: '08:00 Øµ', duration: '45 Ø¯Ù‚ÙŠÙ‚Ø©' };
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØ¯Ø±ÙŠØ³ÙŠØ© Ø¥Ù„Ù‰ Ù†Øµ
        const instructionalGoalsText = weakness.instructionalGoals 
            ? weakness.instructionalGoals.map(goal => `â€¢ ${goal}`).join('<br>')
            : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‡Ø¯Ø§Ù ØªØ¯Ø±ÙŠØ³ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©';
        
        return `
        <tr>
            <td>
                <input type="text" 
                       class="form-control" 
                       value="${escapeHtml(weakness.shortTermGoal)}"
                       data-field="shortTermGoal"
                       data-index="${index}">
            </td>
            <td>
                <textarea class="form-control instructional-goals" 
                          rows="3"
                          data-field="instructionalGoals"
                          data-index="${index}">${weakness.instructionalGoals ? weakness.instructionalGoals.join('\n') : ''}</textarea>
            </td>
            <td>
                <input type="text" 
                       class="form-control" 
                       value="${scheduleSlot.day} - ${scheduleSlot.time}"
                       data-field="schedule"
                       data-index="${index}"
                       placeholder="Ø§Ù„ÙŠÙˆÙ… - Ø§Ù„ÙˆÙ‚Øª">
            </td>
            <td>
                <input type="date" 
                       class="form-control verification-date" 
                       value="${weakness.verificationDate || ''}"
                       data-field="verificationDate"
                       data-index="${index}">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeIEPRow(${index})">
                    Ø­Ø°Ù
                </button>
            </td>
        </tr>
        `;
    }).join('');
}

function populateStudentInfo(iepData) {
    // ØªØ¹Ø¨Ø¦Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const elements = {
        'studentName': iepData.studentName,
        'studentGrade': iepData.studentGrade,
        'teacherName': iepData.teacherName,
        'iepDate': formatDate(iepData.generatedDate),
        'diagnosticDate': iepData.diagnosticTestDate ? formatDate(iepData.diagnosticTestDate) : formatDate(new Date())
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element && elements[id]) {
            element.value = elements[id];
        }
    });
}

function showAutoGeneratedMessage(iepData) {
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
    const message = `
    <div class="alert alert-info mt-3">
        <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ.
        <br><small>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${formatDate(iepData.generatedDate)} | 
        Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©: ${iepData.strengths.length} | 
        Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬: ${iepData.weaknesses.length}</small>
    </div>
    `;
    
    const container = document.getElementById('iepSection');
    if (container) {
        const existingAlert = container.querySelector('.alert-info');
        if (existingAlert) {
            existingAlert.remove();
        }
        container.insertAdjacentHTML('afterbegin', message);
    }
}

// ============================================
// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
// ============================================

function getStudentById(studentId) {
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    return students.find(s => s.id === studentId);
}

function getStudentIEP(studentId) {
    const ieps = JSON.parse(localStorage.getItem('studentIEPs') || '[]');
    return ieps.find(iep => iep.studentId === studentId);
}

function getTeacherSchedule(teacherId) {
    const schedules = JSON.parse(localStorage.getItem('teacherSchedules') || '[]');
    return schedules.find(s => s.teacherId === teacherId) || { slots: [] };
}

function getAvailableScheduleSlots(schedule) {
    if (!schedule || !schedule.slots || schedule.slots.length === 0) {
        // Ø¬Ø¯ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø¯ÙˆÙ„
        return [
            { day: 'Ø§Ù„Ø£Ø­Ø¯', time: '08:00 Øµ', duration: '45 Ø¯Ù‚ÙŠÙ‚Ø©' },
            { day: 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', time: '09:00 Øµ', duration: '45 Ø¯Ù‚ÙŠÙ‚Ø©' },
            { day: 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', time: '10:00 Øµ', duration: '45 Ø¯Ù‚ÙŠÙ‚Ø©' }
        ];
    }
    
    return schedule.slots.filter(slot => slot.available);
}

function addStudentActivity(studentId, activity) {
    const activities = JSON.parse(localStorage.getItem('studentActivities') || '[]');
    
    activities.push({
        id: generateId(),
        studentId: studentId,
        ...activity
    });
    
    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ ÙÙ‚Ø· Ø¨Ø¢Ø®Ø± 50 Ù†Ø´Ø§Ø·
    if (activities.length > 50) {
        activities.splice(0, activities.length - 50);
    }
    
    localStorage.setItem('studentActivities', JSON.stringify(activities));
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA');
}

// ============================================
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù…Ø­ÙÙˆØ¸Ø© ÙƒÙ…Ø§ Ù‡ÙŠ)
// ============================================

function loadStudentProfile(studentId) {
    // ... (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø­ÙÙˆØ¸)
}

function saveIEP() {
    // ... (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø­ÙÙˆØ¸ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø·ÙÙŠÙØ© Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = parseInt(urlParams.get('id'));
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const iepData = collectIEPFormData();
    
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const ieps = JSON.parse(localStorage.getItem('studentIEPs') || '[]');
    const existingIndex = ieps.findIndex(iep => iep.studentId === studentId);
    
    const updatedIEP = {
        ...iepData,
        studentId: studentId,
        lastUpdated: new Date().toISOString(),
        status: 'manually_edited' // ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø£Ù† Ø§Ù„Ù…Ø¹Ù„Ù… Ø¹Ø¯Ù„ Ø¹Ù„ÙŠÙ‡Ø§
    };
    
    if (existingIndex !== -1) {
        ieps[existingIndex] = updatedIEP;
    } else {
        ieps.push(updatedIEP);
    }
    
    localStorage.setItem('studentIEPs', JSON.stringify(ieps));
    showAuthNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ©', 'success');
}

function collectIEPFormData() {
    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const strengths = [];
    const weaknesses = [];
    
    // Ø¬Ù…Ø¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©
    document.querySelectorAll('.strength-item').forEach(item => {
        const goalInput = item.querySelector('.strength-goal');
        if (goalInput && goalInput.value.trim()) {
            strengths.push({
                shortTermGoal: goalInput.value.trim(),
                type: 'strength'
            });
        }
    });
    
    // Ø¬Ù…Ø¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„
    document.querySelectorAll('#iepTableBody tr').forEach((row, index) => {
        const shortTermGoal = row.querySelector('input[data-field="shortTermGoal"]')?.value || '';
        const instructionalGoals = row.querySelector('.instructional-goals')?.value || '';
        const schedule = row.querySelector('input[data-field="schedule"]')?.value || '';
        const verificationDate = row.querySelector('.verification-date')?.value || '';
        
        if (shortTermGoal.trim()) {
            weaknesses.push({
                shortTermGoal: shortTermGoal.trim(),
                instructionalGoals: instructionalGoals.split('\n').filter(g => g.trim()),
                schedule: schedule.trim(),
                verificationDate: verificationDate,
                type: 'weakness'
            });
        }
    });
    
    return {
        strengths: strengths,
        weaknesses: weaknesses,
        collectedDate: new Date().toISOString()
    };
}

// ============================================
// ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
// ============================================

window.removeStrength = function(index) {
    const item = document.querySelector(`.strength-item[data-index="${index}"]`);
    if (item) {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù†Ù‚Ø·Ø© Ø§Ù„Ù‚ÙˆØ© Ù‡Ø°Ù‡ØŸ')) {
            item.remove();
        }
    }
};

window.removeWeakness = function(index) {
    const item = document.querySelector(`.weakness-item[data-index="${index}"]`);
    if (item) {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ù‡Ø°Ù‡ØŸ')) {
            item.remove();
            
            // Ø­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const tableRow = document.querySelector(`#iepTableBody tr td input[data-index="${index}"]`)?.closest('tr');
            if (tableRow) {
                tableRow.remove();
            }
        }
    }
};

window.removeIEPRow = function(index) {
    const row = document.querySelector(`#iepTableBody tr:nth-child(${index + 1})`);
    if (row) {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ø®Ø·Ø©ØŸ')) {
            row.remove();
            
            // Ø­Ø°Ù Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©
            const weaknessItem = document.querySelector(`.weakness-item[data-index="${index}"]`);
            if (weaknessItem) {
                weaknessItem.remove();
            }
        }
    }
};

window.addNewStrength = function() {
    const container = document.getElementById('strengthsList');
    if (!container) return;
    
    const index = container.children.length;
    const newItem = document.createElement('div');
    newItem.className = 'strength-item';
    newItem.setAttribute('data-index', index);
    newItem.innerHTML = `
        <input type="text" 
               class="form-control strength-goal" 
               placeholder="Ù‡Ø¯Ù Ù‚ØµÙŠØ± Ø§Ù„Ù…Ø¯Ù‰ Ø¬Ø¯ÙŠØ¯">
        <button type="button" class="btn btn-sm btn-danger remove-strength" onclick="removeStrength(${index})">
            Ø­Ø°Ù
        </button>
    `;
    
    container.appendChild(newItem);
};

window.addNewWeakness = function() {
    const container = document.getElementById('weaknessesList');
    const tableBody = document.getElementById('iepTableBody');
    
    if (!container || !tableBody) return;
    
    const index = container.children.length;
    
    // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬
    const newWeaknessItem = document.createElement('div');
    newWeaknessItem.className = 'weakness-item';
    newWeaknessItem.setAttribute('data-index', index);
    newWeaknessItem.innerHTML = `
        <input type="text" 
               class="form-control weakness-goal" 
               placeholder="Ù‡Ø¯Ù Ù‚ØµÙŠØ± Ù…Ø¯Ù‰ Ø¬Ø¯ÙŠØ¯">
        <button type="button" class="btn btn-sm btn-danger remove-weakness" onclick="removeWeakness(${index})">
            Ø­Ø°Ù
        </button>
    `;
    
    container.appendChild(newWeaknessItem);
    
    // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <input type="text" 
                   class="form-control" 
                   data-field="shortTermGoal"
                   data-index="${index}"
                   placeholder="Ù‡Ø¯Ù Ù‚ØµÙŠØ± Ø§Ù„Ù…Ø¯Ù‰">
        </td>
        <td>
            <textarea class="form-control instructional-goals" 
                      rows="3"
                      data-field="instructionalGoals"
                      data-index="${index}"
                      placeholder="Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØ¯Ø±ÙŠØ³ÙŠØ© (Ø³Ø·Ø± Ù„ÙƒÙ„ Ù‡Ø¯Ù)"></textarea>
        </td>
        <td>
            <input type="text" 
                   class="form-control" 
                   data-field="schedule"
                   data-index="${index}"
                   placeholder="Ø§Ù„ÙŠÙˆÙ… - Ø§Ù„ÙˆÙ‚Øª">
        </td>
        <td>
            <input type="date" 
                   class="form-control verification-date" 
                   data-field="verificationDate"
                   data-index="${index}">
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeIEPRow(${index})">
                Ø­Ø°Ù
            </button>
        </td>
    `;
    
    tableBody.appendChild(newRow);
};

// ============================================
// Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
// ============================================

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ©ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
if (window.location.pathname.includes('student-profile') && 
    window.location.search.includes('tab=iep')) {
    
    // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ DOM Ø«Ù… Ø§Ù„ØªØ­Ù‚Ù‚
    setTimeout(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = parseInt(urlParams.get('id'));
        
        if (studentId) {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ©
            const iepData = getStudentIEP(studentId);
            
            if (iepData) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø© Ù…Ø­ÙÙˆØ¸Ø©ØŒ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                setTimeout(() => {
                    populateIEPForm(iepData);
                }, 500);
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø®Ø·Ø©ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø®ØªØ¨Ø§Ø± Ù„ØªÙˆÙ„ÙŠØ¯Ù‡Ø§
                checkAndGenerateIEP(studentId);
            }
        }
    }, 1000);
}
