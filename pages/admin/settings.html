<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุนุฏุงุฏุงุช ุงููุธุงู - ููุณุฑ ุงูุชุนูู</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/admin.css">
    <link rel="stylesheet" href="../../assets/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-graduation-cap"></i>
                    <h2>ููุณุฑ ุงูุชุนูู</h2>
                </div>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fas fa-home"></i> ููุญุฉ ุงูุชุญูู</a></li>
                <li><a href="teachers.html"><i class="fas fa-chalkboard-teacher"></i> ุฅุฏุงุฑุฉ ุงููุนูููู</a></li>
                <li><a href="settings.html" class="active"><i class="fas fa-cog"></i> ุงูุฅุนุฏุงุฏุงุช</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ุชุณุฌูู ุงูุฎุฑูุฌ</a></li>
            </ul>
        </aside>

        <main class="main-content-dashboard">
            <header class="dashboard-header">
                <div class="user-info">
                    <div class="user-welcome">
                        <div class="welcome-text">ูุฑุญุจุงู</div>
                        <div class="user-name" id="userName">ูุฏูุฑ ุงููุธุงู</div>
                    </div>
                    <div class="user-avatar" id="userAvatar">ู</div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount">0</span>
                    </button>
                </div>
            </header>

            <div class="dashboard-content">
                <div class="content-header">
                    <h1><i class="fas fa-cog"></i> ุฅุนุฏุงุฏุงุช ุงููุธุงู</h1>
                </div>

                <div class="settings-tabs">
                    <button class="settings-tab active" data-tab="general" onclick="switchSettingsTab('general')">
                        <i class="fas fa-sliders-h"></i> ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ
                    </button>
                    <button class="settings-tab" data-tab="backup" onclick="switchSettingsTab('backup')">
                        <i class="fas fa-database"></i> ุงููุณุฎ ุงูุงุญุชูุงุทู
                    </button>
                    <button class="settings-tab" data-tab="logs" onclick="switchSettingsTab('logs')">
                        <i class="fas fa-clipboard-list"></i> ุณุฌูุงุช ุงููุธุงู
                    </button>
                    <button class="settings-tab" data-tab="security" onclick="switchSettingsTab('security')">
                        <i class="fas fa-shield-alt"></i> ุงูุฃูุงู
                    </button>
                </div>

                <div id="general-tab" class="settings-section">
                    <h3><i class="fas fa-sliders-h"></i> ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ ูููุธุงู</h3>
                    <form id="systemSettingsForm">
                        <div class="settings-grid">
                            <div class="setting-item">
                                <label for="systemName">ุงุณู ุงููุธุงู *</label>
                                <input type="text" id="systemName" class="form-control" required>
                            </div>
                            <div class="setting-item">
                                <label for="systemEmail">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุธุงู</label>
                                <input type="email" id="systemEmail" class="form-control">
                            </div>
                            <div class="setting-item">
                                <label for="sessionTimeout">ูููุฉ ุงูุฌูุณุฉ (ุฏูุงุฆู) *</label>
                                <input type="number" id="sessionTimeout" class="form-control" min="5" max="480" value="60" required>
                                <small class="text-muted">ุงูููุช ูุจู ุงูุชูุงุก ุงูุฌูุณุฉ ุชููุงุฆูุงู (5-480 ุฏูููุฉ)</small>
                            </div>
                            <div class="setting-item">
                                <label for="maxLoginAttempts">ุฃูุตู ูุญุงููุงุช ุชุณุฌูู ุฏุฎูู *</label>
                                <input type="number" id="maxLoginAttempts" class="form-control" min="1" max="10" value="5" required>
                                <small class="text-muted">ุนุฏุฏ ุงููุญุงููุงุช ุงููุณููุญ ุจูุง ูุจู ุชุนููู ุงูุญุณุงุจ</small>
                            </div>
                            <div class="setting-item">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableNotifications" class="form-check" checked>
                                    <span>ุชูุนูู ุงูุฅุดุนุงุฑุงุช</span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableAutoBackup" class="form-check">
                                    <span>ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู</span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <label for="backupFrequency">ุชูุฑุงุฑ ุงููุณุฎ ุงูุงุญุชูุงุทู</label>
                                <select id="backupFrequency" class="form-control">
                                    <option value="daily">ูููู</option>
                                    <option value="weekly">ุฃุณุจูุนู</option>
                                    <option value="monthly">ุดูุฑู</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label for="defaultLanguage">ุงููุบุฉ ุงูุงูุชุฑุงุถูุฉ</label>
                                <select id="defaultLanguage" class="form-control">
                                    <option value="ar" selected>ุงูุนุฑุจูุฉ</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                        </div>
                        <div class="setting-actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> ุญูุธ ุงูุฅุนุฏุงุฏุงุช
                            </button>
                            <button type="button" class="btn btn-warning" onclick="resetSettings()">
                                <i class="fas fa-undo"></i> ุฅุนุงุฏุฉ ุงูุชุนููู
                            </button>
                        </div>
                    </form>
                </div>

                <div id="backup-tab" class="settings-section" style="display: none;">
                    <h3><i class="fas fa-database"></i> ุฅุฏุงุฑุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู</h3>
                    
                    <div class="backup-info">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            ุงููุณุฎ ุงูุงุญุชูุงุทู ูุญูุธ ุฌููุน ุจูุงูุงุช ุงููุธุงู ุจูุง ูู ุฐูู ุงููุณุชุฎุฏููู ูุงูุงุฎุชุจุงุฑุงุช ูุงูุฏุฑูุณ.
                        </div>
                    </div>

                    <div class="backup-stats">
                        <div class="stat-box">
                            <div class="stat-value-box" id="totalBackups">0</div>
                            <div class="stat-label-box">ุฅุฌูุงูู ุงููุณุฎ</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value-box" id="lastBackup">-</div>
                            <div class="stat-label-box">ุขุฎุฑ ูุณุฎุฉ</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value-box" id="backupSize">0</div>
                            <div class="stat-label-box">ุงูุญุฌู ุงูุฅุฌูุงูู</div>
                        </div>
                    </div>

                    <div class="setting-actions">
                        <button class="btn btn-success" onclick="createBackup()">
                            <i class="fas fa-plus"></i> ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
                        </button>
                        <button class="btn btn-info" onclick="importBackup()">
                            <i class="fas fa-file-import"></i> ุงุณุชูุฑุงุฏ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
                        </button>
                    </div>

                    <h4>ุณุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงูููุน</th>
                                    <th>ุงูุญุฌู</th>
                                    <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="backupList">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="logs-tab" class="settings-section" style="display: none;">
                    <h3><i class="fas fa-clipboard-list"></i> ุณุฌูุงุช ุงููุธุงู</h3>
                    
                    <div class="log-filters">
                        <div class="filter-group">
                            <label for="logFilter">ุชุตููุฉ ุญุณุจ ุงูููุน:</label>
                            <select id="logFilter" class="form-control" onchange="filterLogs()">
                                <option value="all">ุงูุฌููุน</option>
                                <option value="info">ูุนูููุงุช</option>
                                <option value="warning">ุชุญุฐูุฑ</option>
                                <option value="error">ุฎุทุฃ</option>
                                <option value="success">ูุฌุงุญ</option>
                                <option value="settings">ุฅุนุฏุงุฏุงุช</option>
                                <option value="backup">ูุณุฎ ุงุญุชูุงุทู</option>
                                <option value="security">ุฃูุงู</option>
                            </select>
                        </div>
                        <div class="log-search-box">
                            <input type="text" id="logSearch" class="form-control" placeholder="ุจุญุซ ูู ุงูุณุฌูุงุช..." onkeyup="filterLogs()">
                            <button class="btn btn-secondary" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ุงูุชุงุฑูุฎ ูุงูููุช</th>
                                    <th>ุงูููุน</th>
                                    <th>ุงูุฑุณุงูุฉ</th>
                                    <th>ุงููุณุชุฎุฏู</th>
                                </tr>
                            </thead>
                            <tbody id="logsList">
                                </tbody>
                        </table>
                    </div>

                    <div class="log-actions">
                        <button class="btn btn-warning" onclick="clearLogs()">
                            <i class="fas fa-trash"></i> ูุณุญ ุงูุณุฌูุงุช
                        </button>
                        <button class="btn btn-info" onclick="exportLogs()">
                            <i class="fas fa-download"></i> ุชุตุฏูุฑ ุงูุณุฌูุงุช
                        </button>
                    </div>
                </div>

                <div id="security-tab" class="settings-section" style="display: none;">
                    <h3><i class="fas fa-shield-alt"></i> ุฅุนุฏุงุฏุงุช ุงูุฃูุงู</h3>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        ูุฐู ุงูุฅุนุฏุงุฏุงุช ุญุณุงุณุฉ. ูุฑุฌู ุงูุญุฐุฑ ุนูุฏ ุงูุชุนุฏูู.
                    </div>

                    <form id="securitySettingsForm">
                        <div class="settings-grid">
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="enableTwoFactor" class="form-check">
                                    ุชูุนูู ุงููุตุงุฏูุฉ ุงูุซูุงุฆูุฉ
                                </label>
                                <small class="text-muted">ุชุชุทูุจ ุงูุชุญูู ุงูุฅุถุงูู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู</small>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="forcePasswordChange" class="form-check">
                                    ุฅุฌุจุงุฑ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ
                                </label>
                                <small class="text-muted">ุฅุฌุจุงุฑ ุงููุณุชุฎุฏููู ุนูู ุชุบููุฑ ูููุงุช ุงููุฑูุฑ ูู 90 ููู</small>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="logAllActivities" class="form-check" checked>
                                    ุชุณุฌูู ุฌููุน ุงูุฃูุดุทุฉ
                                </label>
                                <small class="text-muted">ุชุณุฌูู ุฌููุน ุฃูุดุทุฉ ุงููุณุชุฎุฏููู ูู ุณุฌูุงุช ุงููุธุงู</small>
                            </div>
                            <div class="setting-item">
                                <label for="passwordMinLength">ุงูุญุฏ ุงูุฃุฏูู ููููุฉ ุงููุฑูุฑ</label>
                                <input type="number" id="passwordMinLength" class="form-control" min="6" max="20" value="8">
                                <small class="text-muted">ุงูุญุฏ ุงูุฃุฏูู ูุทูู ูููุฉ ุงููุฑูุฑ (6-20 ุญุฑู)</small>
                            </div>
                            <div class="setting-item">
                                <label for="sessionInactivity">ูููุฉ ุนุฏู ุงููุดุงุท (ุฏูุงุฆู)</label>
                                <input type="number" id="sessionInactivity" class="form-control" min="1" max="60" value="15">
                                <small class="text-muted">ูููุฉ ุงูุชูุงุก ุงูุฌูุณุฉ ุนูุฏ ุนุฏู ุงููุดุงุท</small>
                            </div>
                        </div>
                        
                        <div class="setting-actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุฃูุงู
                            </button>
                            <button type="button" class="btn btn-danger" onclick="resetSecuritySettings()">
                                <i class="fas fa-redo"></i> ุฅุนุงุฏุฉ ุงูุชุนููู
                            </button>
                        </div>
                    </form>

                    <div class="security-stats" style="margin-top: 30px;">
                        <h4>ุฅุญุตุงุฆูุงุช ุงูุฃูุงู</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon">
                                        <i class="fas fa-user-shield"></i>
                                    </div>
                                </div>
                                <div class="stat-number" id="activeSessions">0</div>
                                <div class="stat-label">ุฌูุณุงุช ูุดุทุฉ</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                </div>
                                <div class="stat-number" id="failedLogins">0</div>
                                <div class="stat-label">ูุญุงููุงุช ูุงุดูุฉ</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon">
                                        <i class="fas fa-ban"></i>
                                    </div>
                                </div>
                                <div class="stat-number" id="blockedAccounts">0</div>
                                <div class="stat-label">ุญุณุงุจุงุช ูุญุธูุฑุฉ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="importBackupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ุงุณุชูุฑุงุฏ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</h3>
                <button class="modal-close" onclick="closeImportBackupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ุงุฎุชุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</label>
                    <input type="file" id="backupFile" class="form-control" accept=".json,.txt">
                    <small class="text-muted">ูุฌุจ ุฃู ูููู ุงูููู ุจุตูุบุฉ JSON ุฃู TXT</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="replaceExisting" class="form-check">
                        <span>ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงูุญุงููุฉ</span>
                    </label>
                    <small class="text-muted">ุชุญุฐูุฑ: ูุฐุง ุณูุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ููุณุชุจุฏููุง ุจุจูุงูุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportBackupModal()">ุฅูุบุงุก</button>
                <button class="btn btn-success" onclick="processBackupImport()">ุงุณุชูุฑุงุฏ</button>
            </div>
        </div>
    </div>

    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/admin.js"></script>
    
    <script>
        // ุฏุงูุฉ ูุชุจุฏูู ุชุจููุจุงุช ุงูุฅุนุฏุงุฏุงุช
        function switchSettingsTab(tabName) {
            // ุฅุฒุงูุฉ ุงููุดุงุท ูู ุฌููุน ุงูุฃุฒุฑุงุฑ
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ุฅุฎูุงุก ุฌููุน ุงูุฃูุณุงู
            document.getElementById('general-tab').style.display = 'none';
            document.getElementById('backup-tab').style.display = 'none';
            document.getElementById('logs-tab').style.display = 'none';
            document.getElementById('security-tab').style.display = 'none';
            
            // ุฅุถุงูุฉ ุงููุดุงุท ููุฒุฑ ุงููุญุฏุฏ
            document.querySelector(`.settings-tab[data-tab="${tabName}"]`).classList.add('active');
            
            // ุฅุธูุงุฑ ุงููุณู ุงููุญุฏุฏ
            document.getElementById(`${tabName}-tab`).style.display = 'block';
        }

        // ุชุญููู ุฅุนุฏุงุฏุงุช ุงููุธุงู
        function loadSystemSettings() {
            const settings = JSON.parse(localStorage.getItem('systemSettings') || '{}');
            
            if (Object.keys(settings).length === 0) {
                // ุฅุนุฏุงุฏุงุช ุงูุชุฑุงุถูุฉ
                const defaultSettings = {
                    systemName: 'ููุณุฑ ุงูุชุนูู',
                    systemEmail: '',
                    sessionTimeout: 60,
                    maxLoginAttempts: 5,
                    enableNotifications: true,
                    enableAutoBackup: false,
                    backupFrequency: 'daily',
                    defaultLanguage: 'ar'
                };
                localStorage.setItem('systemSettings', JSON.stringify(defaultSettings));
                loadSystemSettings();
                return;
            }
            
            document.getElementById('systemName').value = settings.systemName || 'ููุณุฑ ุงูุชุนูู';
            document.getElementById('systemEmail').value = settings.systemEmail || '';
            document.getElementById('sessionTimeout').value = settings.sessionTimeout || 60;
            document.getElementById('maxLoginAttempts').value = settings.maxLoginAttempts || 5;
            document.getElementById('enableNotifications').checked = settings.enableNotifications !== false;
            document.getElementById('enableAutoBackup').checked = settings.enableAutoBackup || false;
            document.getElementById('backupFrequency').value = settings.backupFrequency || 'daily';
            document.getElementById('defaultLanguage').value = settings.defaultLanguage || 'ar';
        }

        // ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุธุงู
        function saveSystemSettings() {
            const settings = {
                systemName: document.getElementById('systemName').value.trim(),
                systemEmail: document.getElementById('systemEmail').value.trim(),
                sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
                maxLoginAttempts: parseInt(document.getElementById('maxLoginAttempts').value),
                enableNotifications: document.getElementById('enableNotifications').checked,
                enableAutoBackup: document.getElementById('enableAutoBackup').checked,
                backupFrequency: document.getElementById('backupFrequency').value,
                defaultLanguage: document.getElementById('defaultLanguage').value,
                lastUpdated: new Date().toISOString()
            };

            if (!settings.systemName) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุธุงู');
                return;
            }

            localStorage.setItem('systemSettings', JSON.stringify(settings));
            
            // ุฅุถุงูุฉ ุณุฌู
            addSystemLog('ุชู ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงููุธุงู', 'settings');
            
            alert('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ');
        }

        // ุฅุนุงุฏุฉ ุชุนููู ุงูุฅุนุฏุงุฏุงุช
        function resetSettings() {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุนุงุฏุฉ ุชุนููู ุงูุฅุนุฏุงุฏุงุช ุฅูู ุงูููู ุงูุงูุชุฑุงุถูุฉุ')) {
                return;
            }
            
            const defaultSettings = {
                systemName: 'ููุณุฑ ุงูุชุนูู',
                systemEmail: '',
                sessionTimeout: 60,
                maxLoginAttempts: 5,
                enableNotifications: true,
                enableAutoBackup: false,
                backupFrequency: 'daily',
                defaultLanguage: 'ar',
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('systemSettings', JSON.stringify(defaultSettings));
            loadSystemSettings();
            
            // ุฅุถุงูุฉ ุณุฌู
            addSystemLog('ุชู ุฅุนุงุฏุฉ ุชุนููู ุฅุนุฏุงุฏุงุช ุงููุธุงู', 'settings');
            
            alert('ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ');
        }

        // ุฏูุงู ุงููุณุฎ ุงูุงุญุชูุงุทู
        function loadBackupHistory() {
            const backups = JSON.parse(localStorage.getItem('systemBackups') || '[]');
            const backupList = document.getElementById('backupList');
            
            document.getElementById('totalBackups').textContent = backups.length;
            document.getElementById('backupSize').textContent = backups.length > 0 ? 'ูุชุงุญ' : '0';
            
            if (backups.length > 0) {
                const lastBackup = new Date(backups[backups.length - 1].createdAt);
                document.getElementById('lastBackup').textContent = formatDateShort(lastBackup);
            } else {
                document.getElementById('lastBackup').textContent = '-';
            }
            
            if (backups.length === 0) {
                backupList.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="empty-state">
                                <div class="empty-icon">๐พ</div>
                                <p>ูุง ุชูุฌุฏ ูุณุฎ ุงุญุชูุงุทูุฉ</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            backupList.innerHTML = backups.map((backup, index) => {
                const date = new Date(backup.createdAt);
                const type = backup.type === 'manual' ? 'ูุฏูู' : 'ุชููุงุฆู';
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${formatDate(date)}</td>
                        <td><span class="badge ${backup.type === 'manual' ? 'badge-primary' : 'badge-info'}">${type}</span></td>
                        <td>${backup.size || 'ุบูุฑ ูุนุฑูู'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="downloadBackup(${index})">ุชุญููู</button>
                            <button class="btn btn-sm btn-warning" onclick="restoreBackup(${index})">ุงุณุชุนุงุฏุฉ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function createBackup() {
            if (!confirm('ูู ุชุฑูุฏ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฌุฏูุฏุฉุ')) {
                return;
            }
            
            // ุฌูุน ุงูุจูุงูุงุช ูู localStorage
            const backupData = {};
            const keys = Object.keys(localStorage);
            
            keys.forEach(key => {
                try {
                    backupData[key] = JSON.parse(localStorage.getItem(key));
                } catch (e) {
                    backupData[key] = localStorage.getItem(key);
                }
            });
            
            // ุญูุธ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
            const backups = JSON.parse(localStorage.getItem('systemBackups') || '[]');
            const backup = {
                id: Date.now(),
                createdAt: new Date().toISOString(),
                type: 'manual',
                data: backupData,
                size: JSON.stringify(backupData).length + ' bytes'
            };
            
            backups.push(backup);
            localStorage.setItem('systemBackups', JSON.stringify(backups));
            
            // ุชุญููู ุงูููู ููุชูุฒูู
            const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-muyasir-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // ุฅุถุงูุฉ ุณุฌู
            addSystemLog('ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ', 'backup');
            
            alert('ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ');
            loadBackupHistory();
        }

        function importBackup() {
            document.getElementById('importBackupModal').classList.add('show');
        }

        function closeImportBackupModal() {
            document.getElementById('importBackupModal').classList.remove('show');
            document.getElementById('backupFile').value = '';
        }

        function processBackupImport() {
            const fileInput = document.getElementById('backupFile');
            const replaceExisting = document.getElementById('replaceExisting').checked;
            
            if (!fileInput.files[0]) {
                alert('ูุฑุฌู ุงุฎุชูุงุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!replaceExisting) {
                        // ุฏูุฌ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ูุน ุงูุญุงููุฉ
                        Object.keys(backupData).forEach(key => {
                            try {
                                const currentData = JSON.parse(localStorage.getItem(key) || 'null');
                                if (Array.isArray(currentData) && Array.isArray(backupData[key])) {
                                    // ุฏูุฌ ุงููุตูููุงุช
                                    localStorage.setItem(key, JSON.stringify([...currentData, ...backupData[key]]));
                                } else if (currentData && typeof currentData === 'object' && backupData[key] && typeof backupData[key] === 'object') {
                                    // ุฏูุฌ ุงููุงุฆูุงุช
                                    localStorage.setItem(key, JSON.stringify({...currentData, ...backupData[key]}));
                                } else {
                                    // ุงุณุชุจุฏุงู
                                    localStorage.setItem(key, JSON.stringify(backupData[key]));
                                }
                            } catch (err) {
                                localStorage.setItem(key, JSON.stringify(backupData[key]));
                            }
                        });
                    } else {
                        // ูุณุญ ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุงุณุชุจุฏุงููุง
                        localStorage.clear();
                        Object.keys(backupData).forEach(key => {
                            localStorage.setItem(key, JSON.stringify(backupData[key]));
                        });
                    }
                    
                    // ุฅุถุงูุฉ ุณุฌู
                    addSystemLog('ุชู ุงุณุชูุฑุงุฏ ูุณุฎุฉ ุงุญุชูุงุทูุฉ', 'backup');
                    
                    alert('ุชู ุงุณุชูุฑุงุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ');
                    closeImportBackupModal();
                    loadBackupHistory();
                    
                    if (replaceExisting) {
                        setTimeout(() => {
                            if (confirm('ุชู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุจูุฌุงุญ. ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉุ')) {
                                location.reload();
                            }
                        }, 1000);
                    }
                } catch (error) {
                    alert('ุฎุทุฃ ูู ูุฑุงุกุฉ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: ' + error.message);
                }
            };
            
            reader.readAsText(fileInput.files[0]);
        }

        function downloadBackup(index) {
            const backups = JSON.parse(localStorage.getItem('systemBackups') || '[]');
            const backup = backups[index];
            
            if (!backup) {
                alert('ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ููุฌูุฏุฉ');
                return;
            }
            
            const blob = new Blob([JSON.stringify(backup.data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-muyasir-${index + 1}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // ุฅุถุงูุฉ ุณุฌู
            addSystemLog(`ุชู ุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ${index + 1}`, 'backup');
        }

        function restoreBackup(index) {
            if (!confirm('โ๏ธ ุชุญุฐูุฑ: ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุณุชุญู ูุญู ุงูุจูุงูุงุช ุงูุญุงููุฉ. ูู ุฃูุช ูุชุฃูุฏุ')) {
                return;
            }
            
            const backups = JSON.parse(localStorage.getItem('systemBackups') || '[]');
            const backup = backups[index];
            
            if (!backup) {
                alert('ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ููุฌูุฏุฉ');
                return;
            }
            
            // ูุณุญ ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ
            localStorage.clear();
            
            // ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
            Object.keys(backup.data).forEach(key => {
                localStorage.setItem(key, JSON.stringify(backup.data[key]));
            });
            
            // ุฅุถุงูุฉ ุณุฌู
            addSystemLog(`ุชู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ${index + 1}`, 'backup');
            
            alert('ุชู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ');
            
            setTimeout(() => {
                if (confirm('ุชูุช ุงูุงุณุชุนุงุฏุฉ ุจูุฌุงุญ. ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉุ')) {
                    location.reload();
                }
            }, 1000);
        }

        // ุฏูุงู ุณุฌูุงุช ุงููุธุงู
        function loadSystemLogs() {
            const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
            const logsList = document.getElementById('logsList');
            
            if (logs.length === 0) {
                logsList.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">
                            <div class="empty-state">
                                <p>ูุง ุชูุฌุฏ ุณุฌูุงุช ูุธุงู</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // ุชุฑุชูุจ ูู ุงูุฃุญุฏุซ ุฅูู ุงูุฃูุฏู
            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            logsList.innerHTML = logs.map(log => {
                const date = new Date(log.timestamp);
                const typeClass = getLogTypeClass(log.type);
                
                return `
                    <tr>
                        <td>${formatDate(date)}</td>
                        <td><span class="badge ${typeClass}">${getLogTypeText(log.type)}</span></td>
                        <td>${log.message}</td>
                        <td>${log.user || 'ุงููุธุงู'}</td>
                    </tr>
                `;
            }).join('');
        }

        function getLogTypeClass(type) {
            const classes = {
                'info': 'badge-info',
                'warning': 'badge-warning',
                'error': 'badge-danger',
                'success': 'badge-success',
                'settings': 'badge-primary',
                'backup': 'badge-secondary',
                'security': 'badge-dark'
            };
            return classes[type] || 'badge-light';
        }

        function getLogTypeText(type) {
            const texts = {
                'info': 'ูุนูููุงุช',
                'warning': 'ุชุญุฐูุฑ',
                'error': 'ุฎุทุฃ',
                'success': 'ูุฌุงุญ',
                'settings': 'ุฅุนุฏุงุฏุงุช',
                'backup': 'ูุณุฎ ุงุญุชูุงุทู',
                'security': 'ุฃูุงู'
            };
            return texts[type] || type;
        }

        function addSystemLog(message, type = 'info', user = null) {
            const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
            const currentUser = getCurrentUser();
            
            logs.push({
                timestamp: new Date().toISOString(),
                type: type,
                message: message,
                user: user || (currentUser ? currentUser.name : 'ุงููุธุงู')
            });
            
            // ุงูุงุญุชูุงุธ ููุท ุจุขุฎุฑ 1000 ุณุฌู
            if (logs.length > 1000) {
                logs.splice(0, logs.length - 1000);
            }
            
            localStorage.setItem('systemLogs', JSON.stringify(logs));
            
            // ุชุญุฏูุซ ุงูุนุฑุถ ุฅุฐุง ูุงูุช ุตูุญุฉ ุงูุณุฌูุงุช ููุชูุญุฉ
            if (document.getElementById('logs-tab').style.display !== 'none') {
                loadSystemLogs();
            }
        }

        function filterLogs() {
            const filterType = document.getElementById('logFilter').value;
            const searchTerm = document.getElementById('logSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#logsList tr');
            
            rows.forEach(row => {
                if (row.cells.length < 4) return;
                
                const typeBadge = row.cells[1].querySelector('.badge');
                const type = typeBadge ? typeBadge.textContent.toLowerCase() : '';
                const message = row.cells[2].textContent.toLowerCase();
                const user = row.cells[3].textContent.toLowerCase();
                
                let showRow = true;
                
                if (filterType !== 'all') {
                    const filterText = getLogTypeText(filterType).toLowerCase();
                    if (!type.includes(filterText)) {
                        showRow = false;
                    }
                }
                
                if (searchTerm && !message.includes(searchTerm) && !user.includes(searchTerm)) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        function clearSearch() {
            document.getElementById('logSearch').value = '';
            filterLogs();
        }

        function clearLogs() {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุฌููุน ุณุฌูุงุช ุงููุธุงูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
                return;
            }
            
            localStorage.removeItem('systemLogs');
            
            // ุฅุถุงูุฉ ุณุฌู ูููุณุญ ููุณู
            addSystemLog('ุชู ูุณุญ ุฌููุน ุณุฌูุงุช ุงููุธุงู', 'warning');
            
            alert('ุชู ูุณุญ ุณุฌูุงุช ุงููุธุงู ุจูุฌุงุญ');
            loadSystemLogs();
        }

        function exportLogs() {
            const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
            
            if (logs.length === 0) {
                alert('ูุง ุชูุฌุฏ ุณุฌูุงุช ููุชุตุฏูุฑ');
                return;
            }
            
            const logText = logs.map(log => 
                `${formatDate(new Date(log.timestamp))} - ${getLogTypeText(log.type)} - ${log.user || 'ุงููุธุงู'}: ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('ุชู ุชุตุฏูุฑ ุณุฌูุงุช ุงููุธุงู ุจูุฌุงุญ');
        }

        // ุฏูุงู ุฅุนุฏุงุฏุงุช ุงูุฃูุงู
        function loadSecuritySettings() {
            const settings = JSON.parse(localStorage.getItem('securitySettings') || '{}');
            
            document.getElementById('enableTwoFactor').checked = settings.enableTwoFactor || false;
            document.getElementById('forcePasswordChange').checked = settings.forcePasswordChange || false;
            document.getElementById('logAllActivities').checked = settings.logAllActivities !== false;
            document.getElementById('passwordMinLength').value = settings.passwordMinLength || 8;
            document.getElementById('sessionInactivity').value = settings.sessionInactivity || 15;
            
            // ุชุญููู ุฅุญุตุงุฆูุงุช ุงูุฃูุงู
            loadSecurityStats();
        }

        function saveSecuritySettings() {
            const settings = {
                enableTwoFactor: document.getElementById('enableTwoFactor').checked,
                forcePasswordChange: document.getElementById('forcePasswordChange').checked,
                logAllActivities: document.getElementById('logAllActivities').checked,
                passwordMinLength: parseInt(document.getElementById('passwordMinLength').value),
                sessionInactivity: parseInt(document.getElementById('sessionInactivity').value),
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('securitySettings', JSON.stringify(settings));
            
            // ุฅุถุงูุฉ ุณุฌู
            addSystemLog('ุชู ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูุฃูุงู', 'security');
            
            alert('ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ุจูุฌุงุญ');
        }

        function resetSecuritySettings() {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุนุงุฏุฉ ุชุนููู ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ุฅูู ุงูููู ุงูุงูุชุฑุงุถูุฉุ')) {
                return;
            }
            
            const defaultSettings = {
                enableTwoFactor: false,
                forcePasswordChange: false,
                logAllActivities: true,
                passwordMinLength: 8,
                sessionInactivity: 15,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('securitySettings', JSON.stringify(defaultSettings));
            loadSecuritySettings();
            
            // ุฅุถุงูุฉ ุณุฌู
            addSystemLog('ุชู ุฅุนุงุฏุฉ ุชุนููู ุฅุนุฏุงุฏุงุช ุงูุฃูุงู', 'security');
            
            alert('ุชู ุฅุนุงุฏุฉ ุชุนููู ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ุจูุฌุงุญ');
        }

        function loadSecurityStats() {
            // ูุฐู ุฅุญุตุงุฆูุงุช ุชุฌุฑูุจูุฉ
            document.getElementById('activeSessions').textContent = 1; // ุฌูุณุฉ ุงููุฏูุฑ ุงูุญุงููุฉ
            document.getElementById('failedLogins').textContent = 0;
            document.getElementById('blockedAccounts').textContent = 0;
        }

        // ุฏูุงู ูุณุงุนุฏุฉ
        function formatDate(date) {
            if (!date) return '';
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDateShort(date) {
            if (!date) return '';
            return date.toLocaleDateString('ar-SA');
        }

        // ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุจุฏุก ุงูุชุดุบูู
        document.addEventListener('DOMContentLoaded', function() {
            // ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏู
            const currentUser = getCurrentUser();
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            } else {
                window.location.href = '../../index.html';
                return;
            }
            
            // ุชุญููู ุฌููุน ุงูุจูุงูุงุช
            loadSystemSettings();
            loadBackupHistory();
            loadSystemLogs();
            loadSecuritySettings();
            
            // ุฅุนุฏุงุฏ ุงูููุงุฐุฌ
            document.getElementById('systemSettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSystemSettings();
            });
            
            document.getElementById('securitySettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSecuritySettings();
            });
        });
    </script>
</body>
</html>
