<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الاختبارات التشخيصية - نظام ميسر التعلم</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        /* عنوان الصفحة */
        .page-title {
            margin-bottom: 30px;
            color: var(--secondary-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* الأزرار */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #d5dbdb;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        /* بطاقات الخيارات */
        .option-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 25px;
            margin: 15px 0;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .option-card {
            flex: 1;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .option-card:hover {
            border-color: var(--primary-color);
        }

        .option-card i {
            font-size: 40px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .option-card h3 {
            margin-bottom: 10px;
            color: var(--secondary-color);
        }

        /* الجداول */
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 20px;
            margin-top: 20px;
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .table th, .table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background-color: var(--light-color);
            font-weight: 700;
            color: var(--secondary-color);
        }

        .table tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* الحالات */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-linked {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success-color);
        }

        .status-not-linked {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--danger-color);
        }

        /* نماذج */
        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: var(--secondary-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
            color: var(--secondary-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin: 8px 0;
            font-family: 'Tajawal', sans-serif;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: white;
            font-family: 'Tajawal', sans-serif;
        }

        .question-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .question-type {
            border: 2px solid var(--light-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .question-type:hover {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }

        .question-type i {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* أزرار الإجراءات في الجدول */
        .action-btns {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .view-btn {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        .view-btn:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }

        .edit-btn {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .edit-btn:hover {
            background-color: rgba(243, 156, 18, 0.2);
        }

        .delete-btn {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .delete-btn:hover {
            background-color: rgba(231, 76, 60, 0.2);
        }

        .export-btn {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .export-btn:hover {
            background-color: rgba(39, 174, 96, 0.2);
        }

        /* تصميم متجاوب */
        @media (max-width: 768px) {
            .option-cards {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btns {
                flex-wrap: wrap;
            }
            
            .question-types {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .table th, .table td {
                padding: 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- عنوان الصفحة -->
    <h2 class="page-title">
        <i class="fas fa-clipboard-check"></i>
        الاختبارات التشخيصية
    </h2>

    <!-- خيارات الاختبارات التشخيصية -->
    <div class="option-cards">
        <div class="card option-card" id="createTestBtn">
            <i class="fas fa-plus-circle"></i>
            <h3>إنشاء اختبار تشخيصي جديد</h3>
            <p>قم بإنشاء اختبار تشخيصي جديد وإضافة الأسئلة والأهداف</p>
        </div>
        <div class="card option-card" id="importTestBtn">
            <i class="fas fa-file-import"></i>
            <h3>استيراد اختبار</h3>
            <p>استيراد اختبار تشخيصي تم إنشاؤه مسبقاً من قبل معلم آخر</p>
        </div>
    </div>

    <!-- قائمة الاختبارات التشخيصية -->
    <div class="table-container">
        <h3 style="margin-bottom: 20px; color: var(--secondary-color);">
            <i class="fas fa-list"></i>
            قائمة الاختبارات التشخيصية المضافة
        </h3>
        
        <table class="table">
            <thead>
                <tr>
                    <th>اسم الاختبار</th>
                    <th>المادة</th>
                    <th>الأهداف القصيرة</th>
                    <th>تاريخ الإضافة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="diagnosticTestsTable">
                <!-- سيتم تعبئة البيانات من localStorage هنا -->
            </tbody>
        </table>
    </div>

    <!-- نافذة إنشاء اختبار جديد -->
    <div class="modal-overlay" id="createTestModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> إنشاء اختبار تشخيصي جديد</h2>
                <button class="close-btn" id="closeCreateTestModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createTestForm">
                    <div class="form-group">
                        <label class="form-label">عنوان الاختبار التشخيصي</label>
                        <input type="text" id="diagnosticTestTitle" class="form-control" placeholder="أدخل عنوان الاختبار" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">المادة</label>
                        <select id="diagnosticTestSubject" class="form-select" required>
                            <option value="">اختر المادة</option>
                            <option value="لغتي">لغتي</option>
                            <option value="رياضيات">رياضيات</option>
                            <option value="علوم">علوم</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">وصف الاختبار (اختياري)</label>
                        <textarea id="diagnosticTestDescription" class="form-control" rows="3" placeholder="أدخل وصفاً للاختبار"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">إضافة أسئلة</label>
                        <div class="question-types">
                            <div class="question-type" data-type="multiple-choice">
                                <i class="fas fa-check-circle"></i>
                                <div>اختيار من متعدد</div>
                            </div>
                            <div class="question-type" data-type="drag-drop">
                                <i class="fas fa-arrows-alt"></i>
                                <div>سحب وإفلات</div>
                            </div>
                            <div class="question-type" data-type="image-mcq">
                                <i class="fas fa-image"></i>
                                <div>اختيار من متعدد مع مرفق</div>
                            </div>
                            <div class="question-type" data-type="open-ended">
                                <i class="fas fa-comment-alt"></i>
                                <div>سؤال مفتوح</div>
                            </div>
                            <div class="question-type" data-type="reading-auto">
                                <i class="fas fa-book-reader"></i>
                                <div>تقييم القراءة الآلي</div>
                            </div>
                            <div class="question-type" data-type="spelling-auto">
                                <i class="fas fa-spell-check"></i>
                                <div>تقييم الإملاء الآلي</div>
                            </div>
                            <div class="question-type" data-type="reading-manual">
                                <i class="fas fa-microphone"></i>
                                <div>تقييم القراءة اليدوي</div>
                            </div>
                            <div class="question-type" data-type="spelling-manual">
                                <i class="fas fa-edit"></i>
                                <div>تقييم الإملاء اليدوي</div>
                            </div>
                            <div class="question-type" data-type="missing-letter">
                                <i class="fas fa-font"></i>
                                <div>أكمل الحرف الناقص</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">محك الاجتياز (%)</label>
                        <input type="number" id="diagnosticTestPassingCriteria" class="form-control" min="0" max="100" value="100" required>
                        <small>يجب تحديد نسبة النجاح المطلوبة للاختبار</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelCreateTest">إلغاء</button>
                        <button type="submit" class="btn btn-primary">حفظ الاختبار</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نافذة استيراد اختبار -->
    <div class="modal-overlay" id="importTestModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-file-import"></i> استيراد اختبار تشخيصي</h2>
                <button class="close-btn" id="closeImportTestModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <p>قم برفع ملف الاختبار التشخيصي الذي تريد استيراده. سيتم إضافة الاختبار إلى قائمة الاختبارات المضافة، لكن يجب عليك ربط أسئلة الاختبار بالأهداف القصيرة المتوفرة لديك.</p>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label class="form-label">اختر ملف الاختبار</label>
                        <input type="file" id="importTestFile" class="form-control" accept=".json,.txt">
                        <small>الملف يجب أن يكون بصيغة JSON أو TXT التي تم تصديرها من النظام</small>
                    </div>
                    
                    <div class="card" style="margin-top: 20px; background-color: rgba(243, 156, 18, 0.1);">
                        <h4><i class="fas fa-exclamation-triangle"></i> ملاحظة مهمة</h4>
                        <p>التصدير لا يشمل الأهداف القصيرة المربوطة. يجب على المعلم المستورد للاختبار القيام بربط أسئلة الاختبار بالأهداف القصيرة المتوفرة لديه.</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelImportTest">إلغاء</button>
                        <button type="button" class="btn btn-primary" id="confirmImportTest">استيراد الاختبار</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // التحكم في النوافذ المنبثقة
        document.addEventListener('DOMContentLoaded', function() {
            const createTestBtn = document.getElementById('createTestBtn');
            const importTestBtn = document.getElementById('importTestBtn');
            const createTestModal = document.getElementById('createTestModal');
            const importTestModal = document.getElementById('importTestModal');
            const closeCreateTestModal = document.getElementById('closeCreateTestModal');
            const closeImportTestModal = document.getElementById('closeImportTestModal');
            const cancelCreateTest = document.getElementById('cancelCreateTest');
            const cancelImportTest = document.getElementById('cancelImportTest');
            const confirmImportTest = document.getElementById('confirmImportTest');
            
            // فتح نافذة إنشاء اختبار جديد
            createTestBtn.addEventListener('click', function() {
                createTestModal.classList.add('active');
            });
            
            // فتح نافذة استيراد اختبار
            importTestBtn.addEventListener('click', function() {
                importTestModal.classList.add('active');
            });
            
            // إغلاق نافذة إنشاء اختبار جديد
            closeCreateTestModal.addEventListener('click', function() {
                createTestModal.classList.remove('active');
            });
            
            // إغلاق نافذة استيراد اختبار
            closeImportTestModal.addEventListener('click', function() {
                importTestModal.classList.remove('active');
            });
            
            // إلغاء إنشاء اختبار جديد
            cancelCreateTest.addEventListener('click', function() {
                createTestModal.classList.remove('active');
            });
            
            // إلغاء استيراد اختبار
            cancelImportTest.addEventListener('click', function() {
                importTestModal.classList.remove('active');
            });
            
            // إغلاق النوافذ عند النقر خارجها
            window.addEventListener('click', function(event) {
                if (event.target === createTestModal) {
                    createTestModal.classList.remove('active');
                }
                if (event.target === importTestModal) {
                    importTestModal.classList.remove('active');
                }
            });
            
            // معالجة نموذج إنشاء الاختبار
            document.getElementById('createTestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveDiagnosticTest();
            });
            
            // استيراد الاختبار
            confirmImportTest.addEventListener('click', function() {
                importDiagnosticTest();
            });
            
            // تفاعل أزرار الإجراءات في الجدول
            document.getElementById('diagnosticTestsTable').addEventListener('click', function(e) {
                const btn = e.target.closest('.action-btn');
                if (!btn) return;
                
                const row = btn.closest('tr');
                const testId = parseInt(row.dataset.testId);
                const title = btn.getAttribute('title');
                
                if (title === 'عرض') {
                    viewDiagnosticTest(testId);
                } else if (title === 'تعديل') {
                    editDiagnosticTest(testId);
                } else if (title === 'حذف') {
                    deleteDiagnosticTest(testId);
                } else if (title === 'تصدير') {
                    exportDiagnosticTest(testId);
                }
            });
            
            // تفاعل أنواع الأسئلة
            const questionTypes = document.querySelectorAll('.question-type');
            questionTypes.forEach(type => {
                type.addEventListener('click', function() {
                    const questionType = this.dataset.type;
                    const questionName = this.querySelector('div').textContent;
                    alert(`تم اختيار نوع السؤال: ${questionName}. يمكنك الآن إضافة هذا النوع من الأسئلة إلى الاختبار.`);
                    // هنا يمكنك إضافة وظيفة إضافة السؤال
                });
            });
            
            // تحميل الاختبارات التشخيصية
            loadDiagnosticTests();
        });
        
        // دالة لتحميل الاختبارات التشخيصية
        function loadDiagnosticTests() {
            const tests = JSON.parse(localStorage.getItem('diagnosticTests') || '[]');
            const currentTeacher = getCurrentUser();
            const teacherTests = tests.filter(test => test.teacherId === currentTeacher.id);
            const tableBody = document.getElementById('diagnosticTestsTable');
            
            if (teacherTests.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <div style="color: #666; font-size: 18px;">
                                <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 20px; display: block; color: #ddd;"></i>
                                لا توجد اختبارات تشخيصية
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = teacherTests.map(test => `
                <tr data-test-id="${test.id}">
                    <td>${test.title}</td>
                    <td>${test.subject}</td>
                    <td>
                        <span class="status-badge ${test.objectivesLinked ? 'status-linked' : 'status-not-linked'}">
                            ${test.objectivesLinked ? 'تم الربط' : 'لم يتم الربط'}
                        </span>
                    </td>
                    <td>${formatDate(test.createdAt)}</td>
                    <td>
                        <div class="action-btns">
                            <div class="action-btn view-btn" title="عرض">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="action-btn edit-btn" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn delete-btn" title="حذف">
                                <i class="fas fa-trash"></i>
                            </div>
                            <div class="action-btn export-btn" title="تصدير">
                                <i class="fas fa-download"></i>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // دالة لحفظ الاختبار التشخيصي
        function saveDiagnosticTest() {
            const title = document.getElementById('diagnosticTestTitle').value.trim();
            const subject = document.getElementById('diagnosticTestSubject').value;
            const description = document.getElementById('diagnosticTestDescription').value.trim();
            const passingCriteria = document.getElementById('diagnosticTestPassingCriteria').value;
            
            if (!title || !subject) {
                alert('يرجى ملء جميع الحقول الإجبارية');
                return;
            }
            
            const tests = JSON.parse(localStorage.getItem('diagnosticTests') || '[]');
            const currentTeacher = getCurrentUser();
            
            const newTest = {
                id: generateId(),
                teacherId: currentTeacher.id,
                title: title,
                subject: subject,
                description: description,
                passingCriteria: parseInt(passingCriteria),
                objectivesLinked: false,
                createdAt: new Date().toISOString()
            };
            
            tests.push(newTest);
            localStorage.setItem('diagnosticTests', JSON.stringify(tests));
            
            alert('تم حفظ الاختبار التشخيصي بنجاح!');
            document.getElementById('createTestModal').classList.remove('active');
            document.getElementById('createTestForm').reset();
            loadDiagnosticTests();
        }
        
        // دالة لاستيراد الاختبار
        function importDiagnosticTest() {
            const fileInput = document.getElementById('importTestFile');
            
            if (!fileInput.files[0]) {
                alert('يرجى اختيار ملف للاستيراد');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedTest = JSON.parse(e.target.result);
                    const tests = JSON.parse(localStorage.getItem('diagnosticTests') || '[]');
                    const currentTeacher = getCurrentUser();
                    
                    // تحديث بيانات الاختبار المستورد
                    importedTest.id = generateId();
                    importedTest.teacherId = currentTeacher.id;
                    importedTest.objectivesLinked = false;
                    importedTest.importedAt = new Date().toISOString();
                    
                    tests.push(importedTest);
                    localStorage.setItem('diagnosticTests', JSON.stringify(tests));
                    
                    alert('تم استيراد الاختبار بنجاح!');
                    document.getElementById('importTestModal').classList.remove('active');
                    fileInput.value = '';
                    loadDiagnosticTests();
                } catch (error) {
                    alert('خطأ في قراءة الملف. يرجى التأكد من صيغة الملف');
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
        }
        
        // دالة لعرض الاختبار
        function viewDiagnosticTest(testId) {
            alert('عرض تفاصيل الاختبار - سيتم تطويره لاحقاً');
            // يمكن توجيه المستخدم إلى صفحة عرض تفاصيل الاختبار
        }
        
        // دالة لتعديل الاختبار
        function editDiagnosticTest(testId) {
            alert('فتح نموذج تعديل الاختبار - سيتم تطويره لاحقاً');
        }
        
        // دالة لحذف الاختبار
        function deleteDiagnosticTest(testId) {
            if (!confirm('هل أنت متأكد من حذف هذا الاختبار؟')) {
                return;
            }
            
            const tests = JSON.parse(localStorage.getItem('diagnosticTests') || '[]');
            const updatedTests = tests.filter(test => test.id !== testId);
            localStorage.setItem('diagnosticTests', JSON.stringify(updatedTests));
            
            alert('تم حذف الاختبار');
            loadDiagnosticTests();
        }
        
        // دالة لتصدير الاختبار
        function exportDiagnosticTest(testId) {
            const tests = JSON.parse(localStorage.getItem('diagnosticTests') || '[]');
            const test = tests.find(t => t.id === testId);
            
            if (!test) {
                alert('الاختبار غير موجود');
                return;
            }
            
            // إنشاء ملف JSON للتصدير
            const exportData = {
                ...test,
                exportedAt: new Date().toISOString()
            };
            
            // إزالة البيانات الخاصة بالمعلم الحالي
            delete exportData.teacherId;
            delete exportData.objectivesLinked;
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // إنشاء رابط تحميل
            const downloadUrl = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `اختبار_${test.title.replace(/\s+/g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);
            
            alert('تم تصدير الاختبار كملف، يمكنك الآن إرساله لمعلم آخر');
        }
        
        // دالة المساعد من ملف teacher.js
        function getCurrentUser() {
            const currentUser = localStorage.getItem('currentUser');
            return currentUser ? JSON.parse(currentUser) : { id: 1, name: 'معلم تجريبي', role: 'teacher' };
        }
        
        function generateId() {
            return Math.floor(Math.random() * 1000000) + 1;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
    </script>
</body>
</html>
