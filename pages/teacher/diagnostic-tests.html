<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الاختبارات التشخيصية - نظام ميسر التعلم</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../../assets/css/main.css">
    <link rel="stylesheet" href="../../../assets/css/dashboard.css">
    <link rel="stylesheet" href="../../../assets/css/teacher.css">
    <style>
        /* أنماط إضافية للاختبارات التشخيصية */
        .diagnostic-tests-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-color);
        }

        .test-stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 5px solid;
            transition: transform 0.3s ease;
        }

        .test-stat-card:hover {
            transform: translateY(-5px);
        }

        .test-stat-card.total {
            border-top-color: var(--primary-color);
        }

        .test-stat-card.active {
            border-top-color: var(--success-color);
        }

        .test-stat-card.linked {
            border-top-color: var(--warning-color);
        }

        .test-stat-card.unlinked {
            border-top-color: var(--danger-color);
        }

        .test-stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 10px 0;
        }

        .test-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .test-action-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: var(--shadow);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .test-action-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
        }

        .test-action-card i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .tests-list-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .test-item {
            background: var(--light-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .test-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .test-item-info {
            flex: 1;
        }

        .test-item-title {
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-item-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .test-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-linked {
            background: var(--success-color);
            color: white;
        }

        .badge-unlinked {
            background: var(--danger-color);
            color: white;
        }

        .badge-draft {
            background: var(--warning-color);
            color: white;
        }

        .test-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .empty-tests {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-tests i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* نماذج الاختبارات */
        .test-form-modal .modal-content {
            max-width: 600px;
        }

        .question-type-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .question-type-card {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-type-card:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .question-type-card.selected {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
        }

        .question-type-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .question-item {
            background: var(--light-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-actions {
            display: flex;
            gap: 10px;
        }

        .objectives-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .objectives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .objective-card {
            background: white;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .objective-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .objective-card.selected {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
        }

        /* تحسينات للهواتف */
        @media (max-width: 768px) {
            .diagnostic-tests-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .test-stats-cards {
                grid-template-columns: 1fr 1fr;
            }
            
            .test-actions-grid {
                grid-template-columns: 1fr;
            }
            
            .test-item {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .test-actions {
                width: 100%;
                justify-content: center;
            }
            
            .question-type-options {
                grid-template-columns: 1fr 1fr;
            }
            
            .objectives-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .test-stats-cards {
                grid-template-columns: 1fr;
            }
            
            .test-item-meta {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- الشريط الجانبي -->
        <aside class="sidebar" id="sidebar">
            <!-- سيتم تحميله عبر JavaScript -->
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="main-content-dashboard">
            <!-- رأس الصفحة -->
            <header class="dashboard-header">
                <div class="user-info">
                    <div class="user-welcome">
                        <div class="welcome-text">مرحباً بك،</div>
                        <div class="user-name" id="userName">المعلم</div>
                    </div>
                    <div class="user-avatar" id="userAvatar">م</div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='content-library.html'">
                        <i class="fas fa-arrow-right"></i> العودة للمكتبة
                    </button>
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </header>

            <!-- محتوى الاختبارات التشخيصية -->
            <div class="dashboard-content">
                <div class="diagnostic-tests-header">
                    <h1>
                        <i class="fas fa-clipboard-check"></i>
                        الاختبارات التشخيصية
                    </h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showCreateTestModal()">
                            <i class="fas fa-plus"></i> اختبار جديد
                        </button>
                        <button class="btn btn-secondary" onclick="showImportTestModal()">
                            <i class="fas fa-file-import"></i> استيراد اختبار
                        </button>
                    </div>
                </div>

                <!-- إحصائيات الاختبارات -->
                <div class="test-stats-cards">
                    <div class="test-stat-card total">
                        <div class="test-stat-label">إجمالي الاختبارات</div>
                        <div class="test-stat-value" id="totalTests">0</div>
                        <div class="test-stat-desc">اختبار تشخيصي</div>
                    </div>
                    <div class="test-stat-card active">
                        <div class="test-stat-label">اختبارات نشطة</div>
                        <div class="test-stat-value" id="activeTests">0</div>
                        <div class="test-stat-desc">قيد الاستخدام</div>
                    </div>
                    <div class="test-stat-card linked">
                        <div class="test-stat-label">مرتبطة بأهداف</div>
                        <div class="test-stat-value" id="linkedTests">0</div>
                        <div class="test-stat-desc">أسئلة مرتبطة</div>
                    </div>
                    <div class="test-stat-card unlinked">
                        <div class="test-stat-label">غير مرتبطة</div>
                        <div class="test-stat-value" id="unlinkedTests">0</div>
                        <div class="test-stat-desc">تحتاج ربط</div>
                    </div>
                </div>

                <!-- خيارات سريعة -->
                <div class="test-actions-grid">
                    <div class="test-action-card" onclick="showCreateTestModal()">
                        <i class="fas fa-plus-circle"></i>
                        <h3>إنشاء اختبار جديد</h3>
                        <p>إنشاء اختبار تشخيصي جديد من البداية مع إضافة الأسئلة المناسبة</p>
                    </div>
                    <div class="test-action-card" onclick="showImportTestModal()">
                        <i class="fas fa-file-import"></i>
                        <h3>استيراد اختبار</h3>
                        <p>استيراد اختبار تم إنشاؤه مسبقاً من قبل معلم آخر في النظام</p>
                    </div>
                    <div class="test-action-card" onclick="showTestTemplates()">
                        <i class="fas fa-clone"></i>
                        <h3>قوالب جاهزة</h3>
                        <p>اختيار من مجموعة من القوالب الجاهزة للاختبارات التشخيصية</p>
                    </div>
                    <div class="test-action-card" onclick="exportAllTests()">
                        <i class="fas fa-download"></i>
                        <h3>تصدير جميع الاختبارات</h3>
                        <p>تصدير جميع الاختبارات كملف واحد للمشاركة مع الآخرين</p>
                    </div>
                </div>

                <!-- قائمة الاختبارات -->
                <div class="tests-list-section">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-list"></i>
                            الاختبارات التشخيصية المضافة
                        </h2>
                        <div class="search-box">
                            <input type="text" id="testSearch" placeholder="بحث في الاختبارات..." 
                                   class="form-control" onkeyup="searchTests()">
                            <button class="btn btn-secondary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div id="testsList">
                        <!-- سيتم تحميل الاختبارات هنا عبر JavaScript -->
                        <div class="empty-tests">
                            <i class="fas fa-clipboard-check"></i>
                            <h3>لا توجد اختبارات تشخيصية</h3>
                            <p>قم بإنشاء أول اختبار تشخيصي لبدء استخدام هذه الميزة</p>
                            <button class="btn btn-primary" onclick="showCreateTestModal()">
                                إنشاء أول اختبار
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- نافذة إنشاء اختبار جديد -->
    <div class="modal test-form-modal" id="createTestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> إنشاء اختبار تشخيصي جديد</h3>
                <button class="modal-close" onclick="closeCreateTestModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createTestForm">
                    <div class="form-group">
                        <label class="form-label">اسم الاختبار التشخيصي *</label>
                        <input type="text" class="form-control" id="testName" 
                               placeholder="مثال: اختبار تشخيصي في القراءة للصف الأول" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">المادة *</label>
                        <select class="form-control" id="testSubject" required>
                            <option value="">اختر المادة</option>
                            <option value="لغتي">لغتي</option>
                            <option value="الرياضيات">الرياضيات</option>
                            <option value="العلوم">العلوم</option>
                            <option value="التربية الإسلامية">التربية الإسلامية</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">الوصف (اختياري)</label>
                        <textarea class="form-control" id="testDescription" rows="3" 
                                  placeholder="وصف مختصر للاختبار وأهدافه"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">اختر نوع الأسئلة *</label>
                        <div class="question-type-options">
                            <div class="question-type-card" data-type="multiple-choice" onclick="selectQuestionType(this)">
                                <i class="fas fa-check-circle"></i>
                                <div>اختيار من متعدد</div>
                            </div>
                            <div class="question-type-card" data-type="drag-drop" onclick="selectQuestionType(this)">
                                <i class="fas fa-arrows-alt"></i>
                                <div>سحب وإفلات</div>
                            </div>
                            <div class="question-type-card" data-type="open-ended" onclick="selectQuestionType(this)">
                                <i class="fas fa-comment-alt"></i>
                                <div>سؤال مفتوح</div>
                            </div>
                            <div class="question-type-card" data-type="reading" onclick="selectQuestionType(this)">
                                <i class="fas fa-book-reader"></i>
                                <div>تقييم القراءة</div>
                            </div>
                            <div class="question-type-card" data-type="spelling" onclick="selectQuestionType(this)">
                                <i class="fas fa-spell-check"></i>
                                <div>تقييم الإملاء</div>
                            </div>
                        </div>
                        <input type="hidden" id="selectedQuestionType">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">محك الاجتياز (%) *</label>
                        <input type="number" class="form-control" id="passingGrade" 
                               min="0" max="100" value="100" required>
                        <small class="form-text text-muted">نسبة النجاح المطلوبة لاعتبار الاختبار ناجحاً</small>
                    </div>
                    
                    <div class="objectives-section">
                        <h4><i class="fas fa-bullseye"></i> ربط الأهداف القصيرة (اختياري)</h4>
                        <p class="text-muted">يمكنك ربط أسئلة الاختبار بالأهداف القصيرة المتوفرة لديك</p>
                        
                        <div id="availableObjectives" class="objectives-grid">
                            <!-- سيتم تحميل الأهداف المتاحة هنا -->
                            <div class="empty-state">
                                <p>لا توجد أهداف قصيرة متاحة. يمكنك إنشاء أهداف جديدة أولاً.</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCreateTestModal()">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="saveDiagnosticTest()">حفظ الاختبار</button>
            </div>
        </div>
    </div>

    <!-- نافذة استيراد اختبار -->
    <div class="modal" id="importTestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-import"></i> استيراد اختبار تشخيصي</h3>
                <button class="modal-close" onclick="closeImportTestModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    يمكنك استيراد اختبار تشخيصي تم إنشاؤه مسبقاً من قبل معلم آخر.
                </div>
                
                <div class="form-group">
                    <label class="form-label">اختر ملف الاختبار *</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <p>اسحب وأفلت ملف الاختبار هنا أو انقر للاختيار</p>
                            <p class="text-muted">الملفات المدعومة: .json, .txt</p>
                        </div>
                        <input type="file" id="testFileInput" accept=".json,.txt" style="display: none;">
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-name" id="fileName"></div>
                            <div class="file-size" id="fileSize"></div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>ملاحظة مهمة:</strong> الاستيراد لا يشمل الأهداف القصيرة المربوطة. 
                    يجب عليك القيام بربط أسئلة الاختبار المستورد بالأهداف القصيرة المتوفرة لديك.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImportTestModal()">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="importDiagnosticTest()" id="importBtn" disabled>استيراد الاختبار</button>
            </div>
        </div>
    </div>

    <!-- ربط الأهداف -->
    <div class="modal" id="linkObjectivesModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-link"></i> ربط أسئلة الاختبار بالأهداف</h3>
                <button class="modal-close" onclick="closeLinkObjectivesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="linkObjectivesContent">
                    <!-- سيتم تحميل محتوى الربط هنا -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeLinkObjectivesModal()">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="saveLinkedObjectives()">حفظ الربط</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../../assets/js/auth.js"></script>
    <script src="../../../assets/js/teacher.js"></script>
    <script>
        // التحقق من المصادقة
        document.addEventListener('DOMContentLoaded', function() {
            const user = checkAuth();
            if (!user || user.role !== 'teacher') {
                window.location.href = '../../../index.html';
                return;
            }
            
            // تحديث واجهة المستخدم
            updateUserInterface(user);
            
            // تحميل بيانات الاختبارات
            loadDiagnosticTests();
            
            // تحميل الأهداف المتاحة
            loadAvailableObjectives();
            
            // إعداد رفع الملفات
            setupFileUpload();
            
            // تحميل الشريط الجانبي
            loadSidebar();
        });

        // تحميل الشريط الجانبي
        function loadSidebar() {
            fetch('../../../components/sidebar-teacher.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar').innerHTML = html;
                    // تفعيل الروابط
                    activateSidebarLinks();
                })
                .catch(error => {
                    console.error('Error loading sidebar:', error);
                });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function updateUserInterface(user) {
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userAvatar').textContent = user.name.charAt(0);
        }

        // إدارة الاختبارات التشخيصية
        let diagnosticTests = [];
        let currentTestId = null;

        function loadDiagnosticTests() {
            // محاكاة تحميل البيانات
            setTimeout(() => {
                const storedTests = JSON.parse(localStorage.getItem('teacherDiagnosticTests') || '[]');
                diagnosticTests = storedTests;
                
                updateTestStats();
                displayTests();
            }, 500);
        }

        function updateTestStats() {
            const total = diagnosticTests.length;
            const active = diagnosticTests.filter(t => t.status === 'active').length;
            const linked = diagnosticTests.filter(t => t.hasLinkedObjectives).length;
            const unlinked = total - linked;
            
            document.getElementById('totalTests').textContent = total;
            document.getElementById('activeTests').textContent = active;
            document.getElementById('linkedTests').textContent = linked;
            document.getElementById('unlinkedTests').textContent = unlinked;
        }

        function displayTests() {
            const testsList = document.getElementById('testsList');
            
            if (diagnosticTests.length === 0) {
                testsList.innerHTML = `
                    <div class="empty-tests">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>لا توجد اختبارات تشخيصية</h3>
                        <p>قم بإنشاء أول اختبار تشخيصي لبدء استخدام هذه الميزة</p>
                        <button class="btn btn-primary" onclick="showCreateTestModal()">
                            إنشاء أول اختبار
                        </button>
                    </div>
                `;
                return;
            }
            
            testsList.innerHTML = diagnosticTests.map(test => `
                <div class="test-item">
                    <div class="test-item-info">
                        <div class="test-item-title">
                            <i class="fas fa-clipboard-check"></i>
                            ${test.name}
                        </div>
                        <div class="test-item-meta">
                            <span>المادة: ${test.subject}</span>
                            <span>الأسئلة: ${test.questionCount || 0}</span>
                            <span>تاريخ الإنشاء: ${formatDateShort(test.createdAt)}</span>
                            <span class="test-badge ${test.hasLinkedObjectives ? 'badge-linked' : 'badge-unlinked'}">
                                ${test.hasLinkedObjectives ? 'مرتبط بأهداف' : 'غير مرتبط'}
                            </span>
                        </div>
                    </div>
                    <div class="test-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewTest(${test.id})">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editTest(${test.id})">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        ${!test.hasLinkedObjectives ? `
                            <button class="btn btn-sm btn-info" onclick="linkTestObjectives(${test.id})">
                                <i class="fas fa-link"></i> ربط أهداف
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-success" onclick="exportTest(${test.id})">
                            <i class="fas fa-download"></i> تصدير
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTest(${test.id})">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // النوافذ المنبثقة
        function showCreateTestModal() {
            document.getElementById('createTestModal').classList.add('show');
            document.getElementById('createTestForm').reset();
            resetQuestionTypeSelection();
        }

        function closeCreateTestModal() {
            document.getElementById('createTestModal').classList.remove('show');
        }

        function showImportTestModal() {
            document.getElementById('importTestModal').classList.add('show');
        }

        function closeImportTestModal() {
            document.getElementById('importTestModal').classList.remove('show');
            resetFileUpload();
        }

        function showLinkObjectivesModal() {
            document.getElementById('linkObjectivesModal').classList.add('show');
        }

        function closeLinkObjectivesModal() {
            document.getElementById('linkObjectivesModal').classList.remove('show');
        }

        // إعداد رفع الملفات
        function setupFileUpload() {
            const uploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('testFileInput');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const fileInfo = document.getElementById('fileInfo');
            const importBtn = document.getElementById('importBtn');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary-color)';
                uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '';
                uploadArea.style.backgroundColor = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '';
                uploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            
            function handleFileSelect(file) {
                if (!file.name.match(/\.(json|txt)$/i)) {
                    showAuthNotification('الملف غير مدعوم. يجب أن يكون بصيغة JSON أو TXT', 'error');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showAuthNotification('حجم الملف كبير جداً. الحد الأقصى 10MB', 'error');
                    return;
                }
                
                uploadPlaceholder.style.display = 'none';
                fileInfo.style.display = 'block';
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                importBtn.disabled = false;
            }
        }

        function resetFileUpload() {
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const fileInfo = document.getElementById('fileInfo');
            const fileInput = document.getElementById('testFileInput');
            const importBtn = document.getElementById('importBtn');
            
            uploadPlaceholder.style.display = 'block';
            fileInfo.style.display = 'none';
            fileInput.value = '';
            importBtn.disabled = true;
        }

        // دوال الاختبارات
        function selectQuestionType(card) {
            document.querySelectorAll('.question-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            card.classList.add('selected');
            document.getElementById('selectedQuestionType').value = card.dataset.type;
        }

        function resetQuestionTypeSelection() {
            document.querySelectorAll('.question-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            document.getElementById('selectedQuestionType').value = '';
        }

        function saveDiagnosticTest() {
            const name = document.getElementById('testName').value.trim();
            const subject = document.getElementById('testSubject').value;
            const description = document.getElementById('testDescription').value.trim();
            const questionType = document.getElementById('selectedQuestionType').value;
            const passingGrade = document.getElementById('passingGrade').value;
            
            if (!name || !subject || !questionType) {
                showAuthNotification('يرجى ملء جميع الحقول الإجبارية', 'error');
                return;
            }
            
            const newTest = {
                id: generateId(),
                name: name,
                subject: subject,
                description: description,
                questionType: questionType,
                passingGrade: parseInt(passingGrade),
                questionCount: 0,
                hasLinkedObjectives: false,
                status: 'active',
                createdAt: new Date().toISOString(),
                createdBy: getCurrentUser().id
            };
            
            diagnosticTests.push(newTest);
            localStorage.setItem('teacherDiagnosticTests', JSON.stringify(diagnosticTests));
            
            showAuthNotification('تم إنشاء الاختبار بنجاح', 'success');
            closeCreateTestModal();
            updateTestStats();
            displayTests();
            
            // تسجيل النشاط
            addTeacherActivity({
                type: 'test',
                title: 'أنشأت اختباراً تشخيصياً',
                description: `اختبار جديد: ${name}`
            });
        }

        function importDiagnosticTest() {
            const fileInput = document.getElementById('testFileInput');
            
            if (!fileInput.files.length) {
                showAuthNotification('يرجى اختيار ملف للاستيراد', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedTest = JSON.parse(e.target.result);
                    
                    // تحقق من صحة بنية الاختبار المستورد
                    if (!importedTest.name || !importedTest.subject) {
                        throw new Error('ملف الاختبار غير صالح');
                    }
                    
                    // تعديل بيانات الاختبار للتملك
                    const newTest = {
                        ...importedTest,
                        id: generateId(),
                        hasLinkedObjectives: false, // إعادة تعيين حالة الربط
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser().id,
                        imported: true
                    };
                    
                    diagnosticTests.push(newTest);
                    localStorage.setItem('teacherDiagnosticTests', JSON.stringify(diagnosticTests));
                    
                    showAuthNotification('تم استيراد الاختبار بنجاح', 'success');
                    closeImportTestModal();
                    updateTestStats();
                    displayTests();
                    
                    // تسجيل النشاط
                    addTeacherActivity({
                        type: 'test',
                        title: 'استوردت اختباراً تشخيصياً',
                        description: `اختبار مستورد: ${importedTest.name}`
                    });
                    
                } catch (error) {
                    console.error('Error importing test:', error);
                    showAuthNotification('خطأ في استيراد الملف. تأكد من صحة تنسيق الملف', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function viewTest(testId) {
            const test = diagnosticTests.find(t => t.id === testId);
            if (test) {
                alert(`عرض تفاصيل الاختبار: ${test.name}\nالمادة: ${test.subject}\nالأسئلة: ${test.questionCount}\nالحالة: ${test.hasLinkedObjectives ? 'مرتبط بأهداف' : 'غير مرتبط'}`);
            }
        }

        function editTest(testId) {
            const test = diagnosticTests.find(t => t.id === testId);
            if (test) {
                currentTestId = testId;
                document.getElementById('testName').value = test.name;
                document.getElementById('testSubject').value = test.subject;
                document.getElementById('testDescription').value = test.description || '';
                document.getElementById('passingGrade').value = test.passingGrade;
                
                // تحديد نوع السؤال
                document.querySelectorAll('.question-type-card').forEach(card => {
                    if (card.dataset.type === test.questionType) {
                        card.classList.add('selected');
                        document.getElementById('selectedQuestionType').value = test.questionType;
                    } else {
                        card.classList.remove('selected');
                    }
                });
                
                showCreateTestModal();
            }
        }

        function linkTestObjectives(testId) {
            currentTestId = testId;
            showLinkObjectivesModal();
            
            // تحميل واجهة الربط
            setTimeout(() => {
                document.getElementById('linkObjectivesContent').innerHTML = `
                    <h4>ربط أسئلة الاختبار بالأهداف القصيرة</h4>
                    <p>اختر الأهداف المناسبة لكل سؤال في الاختبار:</p>
                    
                    <div class="questions-section">
                        <!-- هنا سيتم عرض الأسئلة مع خيارات الربط -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            هذه الميزة قيد التطوير. سيتم إكمالها في النسخة القادمة.
                        </div>
                    </div>
                `;
            }, 500);
        }

        function saveLinkedObjectives() {
            if (currentTestId) {
                const testIndex = diagnosticTests.findIndex(t => t.id === currentTestId);
                if (testIndex !== -1) {
                    diagnosticTests[testIndex].hasLinkedObjectives = true;
                    localStorage.setItem('teacherDiagnosticTests', JSON.stringify(diagnosticTests));
                    
                    showAuthNotification('تم ربط الاختبار بالأهداف بنجاح', 'success');
                    closeLinkObjectivesModal();
                    updateTestStats();
                    displayTests();
                }
            }
        }

        function exportTest(testId) {
            const test = diagnosticTests.find(t => t.id === testId);
            if (test) {
                const testData = JSON.stringify(test, null, 2);
                const blob = new Blob([testData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `اختبار_تشخيصي_${test.name.replace(/\s+/g, '_')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAuthNotification('تم تصدير الاختبار بنجاح', 'success');
            }
        }

        function exportAllTests() {
            if (diagnosticTests.length === 0) {
                showAuthNotification('لا توجد اختبارات للتصدير', 'warning');
                return;
            }
            
            const exportData = {
                exportedAt: new Date().toISOString(),
                teacher: getCurrentUser().name,
                tests: diagnosticTests
            };
            
            const testData = JSON.stringify(exportData, null, 2);
            const blob = new Blob([testData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `جميع_الاختبارات_التشخيصية_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAuthNotification('تم تصدير جميع الاختبارات بنجاح', 'success');
        }

        function deleteTest(testId) {
            if (!confirm('هل أنت متأكد من حذف هذا الاختبار؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }
            
            diagnosticTests = diagnosticTests.filter(t => t.id !== testId);
            localStorage.setItem('teacherDiagnosticTests', JSON.stringify(diagnosticTests));
            
            showAuthNotification('تم حذف الاختبار بنجاح', 'success');
            updateTestStats();
            displayTests();
        }

        // البحث والتصفية
        function searchTests() {
            const searchTerm = document.getElementById('testSearch').value.toLowerCase();
            const testItems = document.querySelectorAll('.test-item');
            
            testItems.forEach(item => {
                const testName = item.querySelector('.test-item-title').textContent.toLowerCase();
                if (testName.includes(searchTerm) || searchTerm === '') {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // دوال مساعدة
        function loadAvailableObjectives() {
            // محاكاة تحميل الأهداف المتاحة
            setTimeout(() => {
                const objectives = [
                    { id: 1, title: 'قراءة الكلمات البسيطة', subject: 'لغتي' },
                    { id: 2, title: 'التمييز بين الأصوات المتشابهة', subject: 'لغتي' },
                    { id: 3, title: 'الجمع والطرح ضمن 10', subject: 'الرياضيات' },
                    { id: 4, title: 'التمييز بين الأشكال الهندسية', subject: 'الرياضيات' }
                ];
                
                const objectivesGrid = document.getElementById('availableObjectives');
                if (objectivesGrid) {
                    objectivesGrid.innerHTML = objectives.map(obj => `
                        <div class="objective-card" data-id="${obj.id}">
                            <strong>${obj.title}</strong>
                            <div class="text-muted">${obj.subject}</div>
                        </div>
                    `).join('');
                    
                    // إضافة تفاعل الاختيار
                    document.querySelectorAll('.objective-card').forEach(card => {
                        card.addEventListener('click', function() {
                            this.classList.toggle('selected');
                        });
                    });
                }
            }, 1000);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showTestTemplates() {
            showAuthNotification('قوالب الاختبارات الجاهزة قيد التطوير', 'info');
        }

        // دوال النشاط
        function addTeacherActivity(activity) {
            const activities = JSON.parse(localStorage.getItem('teacherActivities') || '[]');
            activities.push({
                ...activity,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('teacherActivities', JSON.stringify(activities));
        }

        // تفعيل الروابط في الشريط الجانبي
        function activateSidebarLinks() {
            const currentPage = 'content-library.html';
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                }
            });
        }

        // دعم الطباعة
        window.addEventListener('beforeprint', () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        });
    </script>
</body>
</html>
