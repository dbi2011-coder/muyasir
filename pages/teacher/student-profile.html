// =========================================================
// ğŸ“ Ø§Ù„Ù…Ù„Ù: assets/js/student-profile.js
// Ø§Ù„ÙˆØ¸ÙŠÙØ©: Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨ + Ø£ØªÙ…ØªØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø±Ù‚Ù… 9 (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
// =========================================================

let currentStudentId = null;

document.addEventListener('DOMContentLoaded', function() {
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const params = new URLSearchParams(window.location.search);
    let targetId = params.get('id');
    const students = JSON.parse(localStorage.getItem('students') || '[]');

    if (students.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….');
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø±Ù†Ø©)
    let foundStudent = students.find(s => s.id == targetId);

    // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†ÙØªØ­ Ø£ÙˆÙ„ Ø·Ø§Ù„Ø¨ Ù…ØªØ§Ø­
    if (!foundStudent) {
        foundStudent = students[0];
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('id', foundStudent.id);
        window.history.replaceState({}, '', newUrl);
    }

    currentStudentId = foundStudent.id;

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    updateHeaderData(foundStudent);

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    switchSection('diagnostic');
});

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø£Ø³
function updateHeaderData(student) {
    const ids = {
        name: ['headerStudentName', 'sideName'],
        grade: ['sideGrade'],
        avatar: ['sideAvatar']
    };
    
    ids.name.forEach(id => { const el = document.getElementById(id); if(el) el.textContent = student.name; });
    ids.grade.forEach(id => { const el = document.getElementById(id); if(el) el.textContent = student.grade || '-'; });
    ids.avatar.forEach(id => { const el = document.getElementById(id); if(el) el.textContent = student.name.charAt(0); });
}

// =========================================================
// 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (ÙˆØ±Ø¨Ø· Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø®Ø·Ø©)
// =========================================================
window.switchSection = function(sectionId) {
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„
    document.querySelectorAll('.content-section').forEach(el => {
        el.style.display = 'none';
        el.classList.remove('active');
    });
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    const section = document.getElementById(`section-${sectionId}`);
    const link = document.getElementById(`link-${sectionId}`);
    
    if (section) {
        section.style.display = 'block';
        section.classList.add('active');
    }
    if (link) link.classList.add('active');

    // Ø§Ù„Ù„Ø­Ø¸Ø© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø®Ø·Ø© (iep)ØŒ Ù‚Ù… Ø¨ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (sectionId === 'iep') {
        populateIEP_Model9();
    }
};

// =========================================================
// 2. Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ 9 ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
// =========================================================
function populateIEP_Model9() {
    console.log("Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...");

    const allResults = JSON.parse(localStorage.getItem('testResults') || '[]');
    const objectives = JSON.parse(localStorage.getItem('objectives') || '[]');
    const teacherSchedule = JSON.parse(localStorage.getItem('teacherSchedule') || '[]');

    // ØªØ¬Ù…ÙŠØ¹ Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©)
    let allTests = [];
    ['questionBanks', 'tests', 'assessments'].forEach(k => {
        try {
            let d = JSON.parse(localStorage.getItem(k));
            if (Array.isArray(d)) allTests.push(...d);
        } catch(e){}
    });

    // 1. Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†ØªÙŠØ¬Ø© ØªØ´Ø®ÙŠØµÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨
    const result = allResults
        .filter(r => r.studentId == currentStudentId && r.type === 'diagnostic')
        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

    // Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let strengths = [];
    let needs = [];
    let goalsTableData = [];

    // 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Ø§Ù„Ù…Ù†Ø·Ù‚: ØµØ­=Ù‚ÙˆØ©ØŒ Ø®Ø·Ø£=Ø§Ø­ØªÙŠØ§Ø¬ ÙˆÙ‡Ø¯Ù)
    if (result && result.answers) {
        const testRef = allTests.find(t => t.id == result.testId);
        const questionsList = testRef ? (testRef.questions || testRef.items || []) : [];

        result.answers.forEach(ans => {
            // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ±Ø§Ø¨Ø· Ø§Ù„Ù‡Ø¯Ù
            let q = questionsList.find(x => x.id == ans.questionId);
            let goalId = (q && q.linkedGoalId) ? q.linkedGoalId : ans.linkedGoalId;

            if (goalId) {
                const obj = objectives.find(o => o.id == goalId);
                if (obj) {
                    if (ans.isCorrect) {
                        // Ù†Ù‚Ø·Ø© Ù‚ÙˆØ©
                        if (!strengths.includes(obj.shortTermGoal)) strengths.push(obj.shortTermGoal);
                    } else {
                        // Ù†Ù‚Ø·Ø© Ø§Ø­ØªÙŠØ§Ø¬
                        if (!needs.includes(obj.shortTermGoal)) {
                            needs.push(obj.shortTermGoal);
                            
                            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
                            // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø£Ù‡Ø¯Ø§Ù ØªØ¯Ø±ÙŠØ³ÙŠØ© ÙØ±Ø¹ÙŠØ© Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†ÙƒØ±Ø± Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù‚ØµÙŠØ±
                            const instructional = (obj.instructionalGoals && obj.instructionalGoals.length > 0) 
                                ? obj.instructionalGoals 
                                : [obj.shortTermGoal];
                            
                            goalsTableData.push({ short: obj.shortTermGoal, instr: instructional });
                        }
                    }
                }
            }
        });
    }

    // 3. Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ (DOM Manipulation) - Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… .value Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„

    // Ø£) Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©
    const strengthEl = document.getElementById('iep-strengths');
    if (strengthEl) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹ØŒ Ù†Ø¹Ø¨Ø¦Ù‡. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¹Ù„Ù… Ù‚Ø¯ ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹ØŒ Ù„Ø§ Ù†Ù…Ø³Ø­Ù‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        // Ù‡Ù†Ø§ Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ "ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©"
        strengthEl.value = strengths.join('\n'); 
    }

    // Ø¨) Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬
    const needsEl = document.getElementById('iep-needs');
    if (needsEl) {
        needsEl.value = needs.join('\n');
    }

    // Ø¬) Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (ØªÙˆÙ„ÙŠØ¯ ØµÙÙˆÙ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ inputs)
    const goalsBody = document.getElementById('iep-goals-body');
    if (goalsBody) {
        goalsBody.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        
        if (goalsTableData.length > 0) {
            goalsTableData.forEach(group => {
                group.instr.forEach(instrGoal => {
                    const row = `
                        <tr>
                            <td><input type="text" class="form-control" value="${group.short}"></td>
                            
                            <td><input type="text" class="form-control" value="${instrGoal}" style="width:100%"></td>
                            
                            <td><input type="date" class="form-control"></td>
                            <td><input type="text" class="form-control"></td>
                            <td><input type="text" class="form-control"></td>
                        </tr>`;
                    goalsBody.insertAdjacentHTML('beforeend', row);
                });
            });
        } else {
            goalsBody.innerHTML = `<tr><td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‡Ø¯Ø§Ù Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ.</td></tr>`;
        }
    }

    // Ø¯) ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ (Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…)
    fillScheduleFromTeacher(teacherSchedule);
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ
function fillScheduleFromTeacher(scheduleData) {
    const tbody = document.getElementById('iep-schedule-body');
    if (!tbody) return;

    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³'];
    let html = '';

    days.forEach(day => {
        html += `<tr><td><strong>${day}</strong></td>`;
        for (let p = 1; p <= 7; p++) {
            const session = scheduleData.find(s => 
                s.day === day && s.period == p && 
                s.students && s.students.includes(parseInt(currentStudentId))
            );

            if (session) {
                // Ø­ØµØ© Ù…ÙˆØ¬ÙˆØ¯Ø© -> ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
                html += `<td><input type="text" class="form-control" value="${session.subject || 'ØµØ¹ÙˆØ¨Ø§Øª'}" style="background-color:#e8f5e9; text-align:center;"></td>`;
            } else {
                // Ø­ØµØ© ÙØ§Ø±ØºØ©
                html += `<td><input type="text" class="form-control" disabled style="background-color:#f9f9f9;"></td>`;
            }
        }
        html += '</tr>';
    });
    tbody.innerHTML = html;
}

// =========================================================
// 3. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal)
// =========================================================
window.showAssignTestModal = function() {
    const m = document.getElementById('assignTestModal');
    if(m) { m.style.display = 'block'; loadTestsIntoSelect(); }
};
window.closeModal = function(id) {
    const m = document.getElementById(id);
    if(m) m.style.display = 'none';
};
window.onclick = function(e) { if(e.target.classList.contains('modal')) e.target.style.display = 'none'; };

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function loadTestsIntoSelect() {
    const sel = document.getElementById('assignTestSelect');
    if(!sel) return;
    sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</option>';
    
    let all = [];
    ['questionBanks', 'tests', 'assessments'].forEach(k => {
        try { let d = JSON.parse(localStorage.getItem(k)); if(Array.isArray(d)) all.push(...d); } catch(e){}
    });
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
    const unique = Array.from(new Map(all.map(i => [i.id, i])).values());
    unique.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.title || t.name || `Ø§Ø®ØªØ¨Ø§Ø± ${t.id}`;
        sel.appendChild(opt);
    });
}
// Ø­ÙØ¸ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
window.saveAssignedTest = function() {
    const sel = document.getElementById('assignTestSelect');
    if(!sel || !sel.value) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø®ØªØ¨Ø§Ø±');
    
    const list = JSON.parse(localStorage.getItem('assignedTests') || '[]');
    list.push({ id: Date.now(), studentId: currentStudentId, testId: sel.value, status: 'pending', assignedDate: new Date().toISOString() });
    localStorage.setItem('assignedTests', JSON.stringify(list));
    alert('ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯');
    closeModal('assignTestModal');
};
